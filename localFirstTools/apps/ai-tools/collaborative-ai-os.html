<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative AI OS - Shared Workspace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
            user-select: none;
            background: #000;
        }

        /* OS Container */
        #os-container {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #00d4ff;
            position: relative;
            overflow: hidden;
        }

        /* Boot Screen */
        #boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a0a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            transition: opacity 1s ease;
        }

        #boot-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .boot-logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8); }
            50% { text-shadow: 0 0 50px rgba(0, 212, 255, 1); }
        }

        .boot-text {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .boot-progress {
            width: 300px;
            height: 3px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .boot-progress::after {
            content: '';
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Desktop */
        #desktop {
            width: 100%;
            height: calc(100% - 60px);
            position: relative;
            background-image:
                repeating-linear-gradient(0deg,
                    transparent,
                    transparent 50px,
                    rgba(0, 212, 255, 0.03) 50px,
                    rgba(0, 212, 255, 0.03) 51px),
                repeating-linear-gradient(90deg,
                    transparent,
                    transparent 50px,
                    rgba(0, 212, 255, 0.03) 50px,
                    rgba(0, 212, 255, 0.03) 51px);
        }

        /* Windows */
        .window {
            position: absolute;
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            overflow: hidden;
            box-shadow:
                0 20px 60px rgba(0, 212, 255, 0.2),
                inset 0 0 30px rgba(0, 212, 255, 0.05);
            backdrop-filter: blur(10px);
            animation: windowOpen 0.3s ease;
        }

        @keyframes windowOpen {
            0% {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .window.minimized {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        .window.maximized {
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: calc(100% - 60px) !important;
            border-radius: 0;
        }

        .window-titlebar {
            height: 40px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 100, 255, 0.1));
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            cursor: move;
            user-select: none;
        }

        .window-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .ai-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .window-controls {
            display: flex;
            gap: 10px;
        }

        .window-controls button {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .window-controls button:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: scale(1.1);
        }

        .window-controls .close:hover {
            background: rgba(255, 50, 50, 0.5);
        }

        .window-content {
            height: calc(100% - 40px);
            padding: 20px;
            overflow-y: auto;
            color: #ffffff;
        }

        .window-content::-webkit-scrollbar {
            width: 8px;
        }

        .window-content::-webkit-scrollbar-track {
            background: rgba(0, 212, 255, 0.1);
        }

        .window-content::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.3);
            border-radius: 4px;
        }

        /* Taskbar */
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(10, 10, 30, 0.98);
            border-top: 1px solid rgba(0, 212, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            backdrop-filter: blur(20px);
        }

        .start-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 100, 255, 0.2));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #00d4ff;
        }

        .start-button:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(0, 100, 255, 0.3));
            transform: translateY(-2px);
        }

        .taskbar-apps {
            display: flex;
            gap: 10px;
            flex: 1;
            margin: 0 20px;
            overflow-x: auto;
        }

        .taskbar-apps::-webkit-scrollbar {
            height: 4px;
        }

        .taskbar-apps::-webkit-scrollbar-track {
            background: transparent;
        }

        .taskbar-apps::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.3);
            border-radius: 2px;
        }

        .app-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .app-icon:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateY(-5px);
        }

        .app-icon.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: #00d4ff;
            border-radius: 3px;
        }

        .taskbar-tray {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tray-icon {
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tray-icon:hover {
            transform: scale(1.2);
        }

        .tray-icon.active {
            color: #00ff00;
        }

        .time {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Activity Feed */
        .activity-feed {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: rgba(0, 212, 255, 0.05);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .activity-item.user {
            border-left: 3px solid #00d4ff;
        }

        .activity-item.ai {
            border-left: 3px solid #00ff00;
        }

        .activity-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .activity-avatar.user {
            background: rgba(0, 212, 255, 0.2);
        }

        .activity-avatar.ai {
            background: rgba(0, 255, 0, 0.2);
        }

        .activity-content {
            flex: 1;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .activity-author {
            font-weight: bold;
            font-size: 12px;
        }

        .activity-time {
            font-size: 11px;
            opacity: 0.6;
        }

        .activity-text {
            font-size: 13px;
            line-height: 1.4;
        }

        /* AI Command Panel */
        .ai-command-panel {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .ai-command-panel h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #00ff00;
        }

        .command-input-container {
            display: flex;
            gap: 10px;
        }

        .command-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            outline: none;
        }

        .command-input:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .command-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.2), rgba(0, 200, 0, 0.2));
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            color: #00ff00;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .command-btn:hover {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.3), rgba(0, 200, 0, 0.3));
            transform: translateY(-2px);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-action {
            padding: 8px 15px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Data Controls */
        .data-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100001;
            display: flex;
            gap: 10px;
        }

        .data-controls button {
            padding: 8px 16px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .data-controls button:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: translateY(-2px);
        }

        /* Notifications */
        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100002;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            background: rgba(20, 20, 40, 0.98);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            0% {
                transform: translateX(400px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-color: rgba(0, 255, 0, 0.5);
        }

        .notification.error {
            border-color: rgba(255, 0, 0, 0.5);
        }

        /* Terminal Styles */
        .terminal-output {
            background: #000000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            min-height: 400px;
            border-radius: 8px;
            overflow-y: auto;
            font-size: 13px;
        }

        .terminal-line {
            margin-bottom: 5px;
        }

        .terminal-prompt {
            color: #00d4ff;
        }

        /* File Manager */
        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            padding: 10px;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .file-icon {
            font-size: 40px;
        }

        .file-name {
            font-size: 11px;
            text-align: center;
            word-break: break-word;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #808080;
        }

        .status-dot.connected {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .taskbar-apps {
                display: none;
            }

            .window {
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: calc(100% - 60px) !important;
                border-radius: 0;
            }

            .data-controls {
                top: auto;
                bottom: 70px;
                right: 10px;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="os-container">
        <!-- Data Controls -->
        <div class="data-controls">
            <button onclick="collaborativeOS.exportData()">üíæ Export</button>
            <button onclick="document.getElementById('importFile').click()">üìÇ Import</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="collaborativeOS.importData(event)">
        </div>

        <!-- Boot Screen -->
        <div id="boot-screen">
            <div class="boot-logo">ü§ñ COLLABORATIVE AI OS</div>
            <div class="boot-text">Initializing shared workspace...</div>
            <div class="boot-progress"></div>
        </div>

        <!-- Desktop -->
        <div id="desktop"></div>

        <!-- Taskbar -->
        <div id="taskbar">
            <div class="start-button" onclick="collaborativeOS.openApp('command-center')">
                <span>ü§ñ</span>
                <span>Command Center</span>
            </div>
            <div class="taskbar-apps">
                <div class="app-icon" data-app="activity" title="Activity Feed" onclick="collaborativeOS.openApp('activity')">üìä</div>
                <div class="app-icon" data-app="terminal" title="Terminal" onclick="collaborativeOS.openApp('terminal')">‚å®Ô∏è</div>
                <div class="app-icon" data-app="files" title="File Manager" onclick="collaborativeOS.openApp('files')">üìÅ</div>
                <div class="app-icon" data-app="ai-chat" title="AI Chat" onclick="collaborativeOS.openApp('ai-chat')">üí¨</div>
                <div class="app-icon" data-app="settings" title="Settings" onclick="collaborativeOS.openApp('settings')">‚öôÔ∏è</div>
            </div>
            <div class="taskbar-tray">
                <div class="connection-status">
                    <div class="status-dot" id="connection-dot"></div>
                    <span id="connection-text">Disconnected</span>
                </div>
                <div class="time" id="system-time"></div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications"></div>
    </div>

    <script>
        class CollaborativeOS {
            constructor() {
                this.windows = [];
                this.activeWindow = null;
                this.zIndex = 100;
                this.activities = [];
                this.files = {};
                this.connectedToRAPP = false;
                this.rappEndpoint = 'http://localhost:7071/api/businessinsightbot_function';
                this.userGUID = 'collab-os-' + Date.now();
                this.conversationHistory = [];

                this.systemData = this.loadSystemData();
                this.bootSequence();
            }

            loadSystemData() {
                const defaultData = {
                    activities: [],
                    files: {},
                    settings: {
                        rappEndpoint: 'http://localhost:7071/api/businessinsightbot_function',
                        userGUID: this.userGUID
                    }
                };

                const stored = localStorage.getItem('collaborative-os-data');
                return stored ? JSON.parse(stored) : defaultData;
            }

            saveSystemData() {
                localStorage.setItem('collaborative-os-data', JSON.stringify(this.systemData));
            }

            async bootSequence() {
                // Update system time
                setInterval(() => this.updateSystemTime(), 1000);

                // Try to connect to RAPP
                await this.connectToRAPP();

                // Boot animation
                await this.sleep(2000);
                document.getElementById('boot-screen').classList.add('hidden');

                // Open command center by default
                await this.sleep(500);
                this.openApp('command-center');

                this.showNotification('Collaborative OS Online', 'Ready for human-AI collaboration', 'success');
            }

            async connectToRAPP() {
                try {
                    const response = await fetch(this.rappEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_input: 'Hello from Collaborative OS',
                            conversation_history: [],
                            user_guid: this.userGUID
                        })
                    });

                    if (response.ok) {
                        this.connectedToRAPP = true;
                        document.getElementById('connection-dot').classList.add('connected');
                        document.getElementById('connection-text').textContent = 'RAPP Connected';
                        this.logActivity('system', 'Connected to RAPP backend');
                    } else {
                        throw new Error('Connection failed');
                    }
                } catch (error) {
                    console.log('RAPP not available, running in offline mode');
                    document.getElementById('connection-text').textContent = 'Offline Mode';
                    this.logActivity('system', 'Running in offline mode');
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            updateSystemTime() {
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const timeEl = document.getElementById('system-time');
                if (timeEl) timeEl.textContent = time;
            }

            openApp(appName) {
                // Check if already open
                const existingWindow = this.windows.find(w => w.app === appName);
                if (existingWindow) {
                    this.focusWindow(existingWindow);
                    return;
                }

                const apps = {
                    'command-center': this.createCommandCenterWindow(),
                    'activity': this.createActivityWindow(),
                    'terminal': this.createTerminalWindow(),
                    'files': this.createFilesWindow(),
                    'ai-chat': this.createAIChatWindow(),
                    'settings': this.createSettingsWindow()
                };

                const config = apps[appName];
                if (config) {
                    config.app = appName;
                    this.createWindow(config);

                    // Update taskbar
                    const appIcon = document.querySelector(`[data-app="${appName}"]`);
                    if (appIcon) appIcon.classList.add('active');
                }
            }

            createCommandCenterWindow() {
                return {
                    title: 'ü§ñ Command Center',
                    width: 900,
                    height: 700,
                    content: `
                        <div>
                            <h2 style="margin-bottom: 20px;">Collaborative AI Workspace</h2>

                            <div class="activity-feed" style="max-height: 250px;">
                                <h3 style="margin-bottom: 10px;">Recent Activity</h3>
                                <div id="activity-feed-content">
                                    ${this.systemData.activities.slice(-5).map(a => this.renderActivityItem(a)).join('')}
                                </div>
                            </div>

                            <div class="ai-command-panel">
                                <h3><span class="ai-indicator"></span> AI Command Interface</h3>
                                <p style="opacity: 0.7; margin-bottom: 15px; font-size: 13px;">
                                    Send commands to the AI assistant. The AI can interact with this OS on your behalf.
                                </p>

                                <div class="command-input-container">
                                    <input type="text"
                                           class="command-input"
                                           id="ai-command-input"
                                           placeholder="Enter command for AI (e.g., 'open terminal', 'create file notes.txt', 'analyze system')"
                                           onkeypress="if(event.key==='Enter') collaborativeOS.sendAICommand()">
                                    <button class="command-btn" onclick="collaborativeOS.sendAICommand()">
                                        ‚ñ∂ Execute
                                    </button>
                                </div>

                                <div class="quick-actions">
                                    <div class="quick-action" onclick="collaborativeOS.quickCommand('open terminal')">Open Terminal</div>
                                    <div class="quick-action" onclick="collaborativeOS.quickCommand('show activity')">Show Activity</div>
                                    <div class="quick-action" onclick="collaborativeOS.quickCommand('list files')">List Files</div>
                                    <div class="quick-action" onclick="collaborativeOS.quickCommand('system status')">System Status</div>
                                </div>
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: rgba(0,212,255,0.05); border-radius: 10px;">
                                <h4 style="margin-bottom: 10px;">üí° Quick Tips</h4>
                                <ul style="font-size: 13px; line-height: 1.8; opacity: 0.8; padding-left: 20px;">
                                    <li>The AI can see and manipulate this OS environment</li>
                                    <li>All actions are logged in the Activity Feed</li>
                                    <li>Use commands like "create", "open", "analyze", "help"</li>
                                    <li>The AI can run terminal commands for you</li>
                                </ul>
                            </div>
                        </div>
                    `
                };
            }

            createActivityWindow() {
                return {
                    title: 'üìä Activity Feed',
                    width: 700,
                    height: 600,
                    content: `
                        <div>
                            <h2 style="margin-bottom: 20px;">Activity History</h2>
                            <div class="activity-feed" style="max-height: 500px;">
                                ${this.systemData.activities.map(a => this.renderActivityItem(a)).join('') ||
                                  '<p style="opacity: 0.5; text-align: center;">No activities yet</p>'}
                            </div>
                        </div>
                    `
                };
            }

            createTerminalWindow() {
                return {
                    title: '‚å®Ô∏è Terminal',
                    width: 800,
                    height: 500,
                    content: `
                        <div class="terminal-output" id="terminal-output">
                            <div class="terminal-line"><span class="terminal-prompt">collab-os@workspace:~$</span> Connected</div>
                            <div class="terminal-line">Type 'help' for available commands</div>
                            <div class="terminal-line"></div>
                        </div>
                        <div style="display: flex; align-items: center; margin-top: 10px; background: #000; padding: 10px; border-radius: 8px;">
                            <span class="terminal-prompt" style="margin-right: 10px;">collab-os@workspace:~$</span>
                            <input type="text"
                                   id="terminal-input"
                                   style="flex: 1; background: transparent; border: none; color: #00ff00; font-family: 'Courier New', monospace; outline: none;"
                                   onkeypress="if(event.key==='Enter') collaborativeOS.executeTerminalCommand(this.value)">
                        </div>
                    `
                };
            }

            createFilesWindow() {
                return {
                    title: 'üìÅ File Manager',
                    width: 800,
                    height: 600,
                    content: `
                        <div>
                            <h2 style="margin-bottom: 20px;">Shared Files</h2>
                            <div class="file-list" id="file-list">
                                ${this.renderFileList()}
                            </div>
                        </div>
                    `
                };
            }

            createAIChatWindow() {
                return {
                    title: 'üí¨ AI Chat',
                    width: 600,
                    height: 650,
                    content: `
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div class="activity-feed" style="flex: 1; margin-bottom: 15px;">
                                <div id="ai-chat-messages"></div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text"
                                       class="command-input"
                                       id="ai-chat-input"
                                       placeholder="Chat with AI assistant..."
                                       onkeypress="if(event.key==='Enter') collaborativeOS.sendChatMessage()">
                                <button class="command-btn" onclick="collaborativeOS.sendChatMessage()">Send</button>
                            </div>
                        </div>
                    `
                };
            }

            createSettingsWindow() {
                return {
                    title: '‚öôÔ∏è Settings',
                    width: 600,
                    height: 500,
                    content: `
                        <div>
                            <h2 style="margin-bottom: 20px;">System Settings</h2>

                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px; color: #00d4ff;">RAPP Connection</h3>
                                <input type="text"
                                       class="command-input"
                                       id="rapp-endpoint"
                                       value="${this.rappEndpoint}"
                                       style="margin-bottom: 10px;">
                                <button class="command-btn" onclick="collaborativeOS.updateRAPPEndpoint()">Update Endpoint</button>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px; color: #00d4ff;">User GUID</h3>
                                <input type="text"
                                       class="command-input"
                                       id="user-guid"
                                       value="${this.userGUID}"
                                       readonly
                                       style="margin-bottom: 10px;">
                            </div>

                            <div>
                                <h3 style="margin-bottom: 10px; color: #00d4ff;">System Info</h3>
                                <p style="font-size: 13px; opacity: 0.8;">Windows: ${this.windows.length}</p>
                                <p style="font-size: 13px; opacity: 0.8;">Activities: ${this.systemData.activities.length}</p>
                                <p style="font-size: 13px; opacity: 0.8;">Connection: ${this.connectedToRAPP ? 'Connected' : 'Offline'}</p>
                            </div>
                        </div>
                    `
                };
            }

            renderActivityItem(activity) {
                return `
                    <div class="activity-item ${activity.type}">
                        <div class="activity-avatar ${activity.type}">
                            ${activity.type === 'user' ? 'üë§' : 'ü§ñ'}
                        </div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <span class="activity-author">${activity.type === 'user' ? 'You' : activity.type === 'ai' ? 'AI Assistant' : 'System'}</span>
                                <span class="activity-time">${new Date(activity.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="activity-text">${activity.message}</div>
                        </div>
                    </div>
                `;
            }

            renderFileList() {
                const files = Object.entries(this.systemData.files);
                if (files.length === 0) {
                    return '<p style="opacity: 0.5; text-align: center; padding: 40px;">No files yet</p>';
                }

                return files.map(([name, content]) => `
                    <div class="file-item" onclick="collaborativeOS.openFile('${name}')">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-name">${name}</div>
                    </div>
                `).join('');
            }

            createWindow(config) {
                const windowId = 'window-' + Date.now();
                const window = {
                    id: windowId,
                    app: config.app || null,
                    title: config.title || 'Untitled',
                    width: config.width || 800,
                    height: config.height || 600,
                    x: 100 + (this.windows.length * 30),
                    y: 100 + (this.windows.length * 30),
                    minimized: false,
                    maximized: false,
                    zIndex: this.zIndex++
                };

                const windowEl = document.createElement('div');
                windowEl.id = windowId;
                windowEl.className = 'window';
                windowEl.style.cssText = `
                    left: ${window.x}px;
                    top: ${window.y}px;
                    width: ${window.width}px;
                    height: ${window.height}px;
                    z-index: ${window.zIndex};
                `;

                windowEl.innerHTML = `
                    <div class="window-titlebar">
                        <div class="window-title">
                            ${config.title}
                            ${config.app === 'command-center' || config.app === 'ai-chat' ? '<span class="ai-indicator"></span>' : ''}
                        </div>
                        <div class="window-controls">
                            <button class="minimize" onclick="collaborativeOS.minimizeWindow('${windowId}')">‚àí</button>
                            <button class="maximize" onclick="collaborativeOS.maximizeWindow('${windowId}')">‚ñ°</button>
                            <button class="close" onclick="collaborativeOS.closeWindow('${windowId}')">√ó</button>
                        </div>
                    </div>
                    <div class="window-content">
                        ${config.content || ''}
                    </div>
                `;

                document.getElementById('desktop').appendChild(windowEl);

                // Make draggable
                this.makeDraggable(windowEl, window);
                // Focus on click
                windowEl.addEventListener('mousedown', () => this.focusWindow(window));

                this.windows.push(window);
                this.focusWindow(window);
            }

            makeDraggable(element, window) {
                const titlebar = element.querySelector('.window-titlebar');
                let isDragging = false;
                let startX, startY, initialX, initialY;

                titlebar.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.window-controls')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = window.x;
                    initialY = window.y;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    window.x = initialX + (e.clientX - startX);
                    window.y = initialY + (e.clientY - startY);
                    element.style.left = window.x + 'px';
                    element.style.top = window.y + 'px';
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            focusWindow(window) {
                this.activeWindow = window;
                window.zIndex = this.zIndex++;
                const el = document.getElementById(window.id);
                if (el) el.style.zIndex = window.zIndex;
            }

            minimizeWindow(windowId) {
                const window = this.windows.find(w => w.id === windowId);
                if (!window) return;
                window.minimized = true;
                document.getElementById(windowId).classList.add('minimized');
            }

            maximizeWindow(windowId) {
                const window = this.windows.find(w => w.id === windowId);
                if (!window) return;
                window.maximized = !window.maximized;
                document.getElementById(windowId).classList.toggle('maximized');
            }

            closeWindow(windowId) {
                const window = this.windows.find(w => w.id === windowId);
                if (!window) return;

                const element = document.getElementById(windowId);
                element.style.animation = 'windowOpen 0.3s ease reverse';
                setTimeout(() => element.remove(), 300);

                this.windows = this.windows.filter(w => w.id !== windowId);

                // Update taskbar
                if (window.app) {
                    const appIcon = document.querySelector(`[data-app="${window.app}"]`);
                    if (appIcon) appIcon.classList.remove('active');
                }
            }

            logActivity(type, message) {
                const activity = {
                    type: type,
                    message: message,
                    timestamp: Date.now()
                };

                this.systemData.activities.push(activity);
                this.saveSystemData();

                // Update activity feeds if windows are open
                const activityFeedContent = document.getElementById('activity-feed-content');
                if (activityFeedContent) {
                    activityFeedContent.insertAdjacentHTML('beforeend', this.renderActivityItem(activity));
                }
            }

            async sendAICommand() {
                const input = document.getElementById('ai-command-input');
                if (!input || !input.value) return;

                const command = input.value;
                input.value = '';

                this.logActivity('user', `Sent AI command: ${command}`);

                if (!this.connectedToRAPP) {
                    this.simulateAIResponse(command);
                    return;
                }

                try {
                    const response = await fetch(this.rappEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_input: command,
                            conversation_history: this.conversationHistory,
                            user_guid: this.userGUID
                        })
                    });

                    const data = await response.json();
                    this.conversationHistory.push({
                        role: 'user',
                        content: command
                    });
                    this.conversationHistory.push({
                        role: 'assistant',
                        content: data.assistant_response || data.response
                    });

                    this.logActivity('ai', data.assistant_response || data.response);
                    this.processAICommand(command, data);
                } catch (error) {
                    this.showNotification('Error', 'Failed to send command to AI', 'error');
                    this.simulateAIResponse(command);
                }
            }

            simulateAIResponse(command) {
                const responses = {
                    'open terminal': () => {
                        this.openApp('terminal');
                        return 'Opening terminal window for you.';
                    },
                    'show activity': () => {
                        this.openApp('activity');
                        return 'Displaying activity feed.';
                    },
                    'list files': () => {
                        this.openApp('files');
                        return 'Opening file manager.';
                    },
                    'system status': () => {
                        return `System Status:\n- Windows: ${this.windows.length} open\n- Activities: ${this.systemData.activities.length} logged\n- Connection: ${this.connectedToRAPP ? 'Connected' : 'Offline'}`;
                    },
                    'default': () => {
                        return `Command received: "${command}". In offline mode, I can only simulate responses. Connect to RAPP for full AI capabilities.`;
                    }
                };

                const handler = Object.keys(responses).find(key => command.toLowerCase().includes(key)) || 'default';
                const response = responses[handler]();

                setTimeout(() => {
                    this.logActivity('ai', response);
                }, 500);
            }

            processAICommand(command, data) {
                // Process AI response and execute any OS commands
                if (command.toLowerCase().includes('open terminal')) {
                    this.openApp('terminal');
                } else if (command.toLowerCase().includes('open') && command.toLowerCase().includes('activity')) {
                    this.openApp('activity');
                } else if (command.toLowerCase().includes('files')) {
                    this.openApp('files');
                }
            }

            quickCommand(command) {
                const input = document.getElementById('ai-command-input');
                if (input) {
                    input.value = command;
                    this.sendAICommand();
                }
            }

            executeTerminalCommand(command) {
                const output = document.getElementById('terminal-output');
                const input = document.getElementById('terminal-input');

                if (!output || !command) return;

                // Add command to output
                output.innerHTML += `<div class="terminal-line"><span class="terminal-prompt">collab-os@workspace:~$</span> ${command}</div>`;

                // Execute command
                const result = this.handleTerminalCommand(command);
                output.innerHTML += `<div class="terminal-line">${result}</div>`;
                output.innerHTML += `<div class="terminal-line"></div>`;

                // Clear input
                if (input) input.value = '';

                // Scroll to bottom
                output.scrollTop = output.scrollHeight;

                // Log activity
                this.logActivity('user', `Terminal: ${command}`);
            }

            handleTerminalCommand(command) {
                const parts = command.split(' ');
                const cmd = parts[0].toLowerCase();

                switch(cmd) {
                    case 'help':
                        return 'Available commands: help, clear, ls, pwd, echo, date, whoami, exit';
                    case 'clear':
                        const output = document.getElementById('terminal-output');
                        if (output) output.innerHTML = '';
                        return '';
                    case 'ls':
                        return Object.keys(this.systemData.files).join('\n') || 'No files';
                    case 'pwd':
                        return '/home/collab-os';
                    case 'echo':
                        return parts.slice(1).join(' ');
                    case 'date':
                        return new Date().toString();
                    case 'whoami':
                        return 'collab-os-user';
                    case 'exit':
                        this.closeWindow(this.windows.find(w => w.app === 'terminal')?.id);
                        return 'Exiting...';
                    default:
                        return `Command not found: ${cmd}`;
                }
            }

            async sendChatMessage() {
                const input = document.getElementById('ai-chat-input');
                const messagesDiv = document.getElementById('ai-chat-messages');

                if (!input || !messagesDiv || !input.value) return;

                const message = input.value;
                input.value = '';

                // Add user message
                messagesDiv.innerHTML += this.renderActivityItem({
                    type: 'user',
                    message: message,
                    timestamp: Date.now()
                });

                this.logActivity('user', `Chat: ${message}`);

                // Simulate or send to RAPP
                if (this.connectedToRAPP) {
                    try {
                        const response = await fetch(this.rappEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_input: message,
                                conversation_history: this.conversationHistory,
                                user_guid: this.userGUID
                            })
                        });

                        const data = await response.json();
                        const aiMessage = data.assistant_response || data.response;

                        messagesDiv.innerHTML += this.renderActivityItem({
                            type: 'ai',
                            message: aiMessage,
                            timestamp: Date.now()
                        });

                        this.logActivity('ai', `Chat: ${aiMessage}`);
                    } catch (error) {
                        messagesDiv.innerHTML += this.renderActivityItem({
                            type: 'ai',
                            message: 'Error connecting to AI. Running in offline mode.',
                            timestamp: Date.now()
                        });
                    }
                } else {
                    setTimeout(() => {
                        messagesDiv.innerHTML += this.renderActivityItem({
                            type: 'ai',
                            message: `I received your message: "${message}". Connect to RAPP for full AI capabilities.`,
                            timestamp: Date.now()
                        });
                    }, 500);
                }

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            openFile(fileName) {
                this.showNotification('File Manager', `Opening ${fileName}`);
            }

            updateRAPPEndpoint() {
                const input = document.getElementById('rapp-endpoint');
                if (input) {
                    this.rappEndpoint = input.value;
                    this.systemData.settings.rappEndpoint = input.value;
                    this.saveSystemData();
                    this.showNotification('Settings', 'RAPP endpoint updated. Reconnecting...', 'success');
                    this.connectToRAPP();
                }
            }

            showNotification(title, message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <strong>${title}</strong>
                    <div style="margin-top: 5px; opacity: 0.8; font-size: 14px;">${message}</div>
                `;

                const container = document.getElementById('notifications');
                container.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            exportData() {
                const dataStr = JSON.stringify(this.systemData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `collaborative-os-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                this.showNotification('Export', 'Data exported successfully', 'success');
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.systemData = data;
                        this.saveSystemData();
                        location.reload();
                    } catch (error) {
                        this.showNotification('Error', 'Invalid JSON file', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize Collaborative OS
        let collaborativeOS;
        window.addEventListener('DOMContentLoaded', () => {
            collaborativeOS = new CollaborativeOS();
        });

        // Prevent context menu
        document.addEventListener('contextmenu', e => e.preventDefault());

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && collaborativeOS.activeWindow) {
                collaborativeOS.closeWindow(collaborativeOS.activeWindow.id);
            }
        });
    </script>
</body>
</html>
