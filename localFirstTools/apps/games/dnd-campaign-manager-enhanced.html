<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Campaign Manager - Enhanced</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1e;
            background-image:
                radial-gradient(at 40% 20%, rgba(120, 119, 198, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(255, 107, 107, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(78, 205, 196, 0.1) 0px, transparent 50%);
            color: #e4e4e4;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(15, 15, 30, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(2em, 5vw, 3.5em);
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 25%, #4ecdc4 50%, #a78bfa 75%, #ff6b6b 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: shimmer 8s linear infinite;
            font-weight: 700;
            letter-spacing: 2px;
        }

        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .header p {
            color: #a0a0c0;
            font-size: 1.1em;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .connection-panel {
            background: rgba(20, 20, 40, 0.8);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .connection-panel h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.5em;
        }

        .connection-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0c0;
            font-size: 0.9em;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            border-radius: 10px;
            background: rgba(15, 15, 30, 0.6);
            color: #e4e4e4;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4ecdc4;
            background: rgba(15, 15, 30, 0.9);
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(78, 205, 196, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd93d 0%, #f39c12 100%);
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(255, 217, 61, 0.4);
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 217, 61, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .connection-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-connected {
            background: linear-gradient(135deg, #44a08d, #093637);
            color: white;
            box-shadow: 0 0 20px rgba(68, 160, 141, 0.4);
        }

        .status-disconnected {
            background: #555;
            color: #ccc;
        }

        .game-container {
            display: grid;
            grid-template-columns: 340px 1fr 340px;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(20, 20, 40, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h3 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-card {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.15), rgba(78, 205, 196, 0.05));
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .player-card:hover::before {
            left: 100%;
        }

        .player-card.active {
            border-color: #ffd93d;
            box-shadow:
                0 0 30px rgba(255, 217, 61, 0.4),
                inset 0 0 30px rgba(255, 217, 61, 0.1);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-info {
            font-size: 0.9em;
            color: #a0a0c0;
            margin-bottom: 10px;
        }

        .health-bar {
            background: rgba(0, 0, 0, 0.4);
            height: 28px;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            margin: 12px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 50%, #ff6b6b 100%);
            background-size: 200% 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            position: relative;
            animation: healthShimmer 3s linear infinite;
        }

        @keyframes healthShimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: healthGloss 2s ease-in-out infinite;
        }

        @keyframes healthGloss {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .campaign-log {
            max-height: 500px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .log-entry {
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
            transition: all 0.2s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .log-entry.combat {
            border-left-color: #ff6b6b;
        }

        .log-entry.story {
            border-left-color: #4ecdc4;
        }

        .log-entry.system {
            border-left-color: #a0a0c0;
        }

        .combat-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .enemy-card {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.05));
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .enemy-card:hover {
            border-color: #ff6b6b;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }

        .enemy-card.selected {
            border-color: #ffd93d;
            box-shadow: 0 0 25px rgba(255, 217, 61, 0.5);
        }

        .enemy-card.defeated {
            opacity: 0.4;
            filter: grayscale(100%);
            cursor: not-allowed;
        }

        .enemy-name {
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .enemy-stats {
            font-size: 0.85em;
            color: #a0a0c0;
            margin-top: 8px;
            display: flex;
            gap: 12px;
        }

        .dice-roller {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .dice-result {
            font-size: 3em;
            text-align: center;
            color: #ffd93d;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 217, 61, 0.6);
            animation: diceRoll 0.5s ease-out;
        }

        @keyframes diceRoll {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .scroll-container {
            max-height: 520px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4ecdc4, #44a08d);
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5eddcd, #54b09d);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1e3c, #16213e);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h2 {
            color: #4ecdc4;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #a0a0c0;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            border-radius: 10px;
            background: rgba(15, 15, 30, 0.6);
            color: #e4e4e4;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4ecdc4;
            background: rgba(15, 15, 30, 0.9);
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .quest-card {
            background: linear-gradient(135deg, rgba(255, 217, 61, 0.15), rgba(255, 217, 61, 0.05));
            border: 2px solid rgba(255, 217, 61, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .quest-card:hover {
            border-color: #ffd93d;
            box-shadow: 0 4px 20px rgba(255, 217, 61, 0.3);
            transform: translateY(-2px);
        }

        .quest-title {
            color: #ffd93d;
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .quest-description {
            color: #c0c0d0;
            font-size: 0.95em;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .quest-reward {
            color: #4ecdc4;
            font-size: 0.9em;
            font-weight: 500;
        }

        .turn-indicator {
            background: linear-gradient(135deg, #ffd93d, #f39c12);
            color: #1a1a2e;
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(255, 217, 61, 0.4);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 217, 61, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(255, 217, 61, 0.7); }
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .quick-actions .btn {
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .game-container {
                gap: 15px;
            }

            .panel {
                padding: 16px;
            }

            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .combat-controls {
                grid-template-columns: 1fr;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.95em;
            }
        }

        .floating-damage {
            position: fixed;
            font-size: 2em;
            font-weight: 700;
            pointer-events: none;
            z-index: 9999;
            animation: floatUp 1.5s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        .combat-action-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9998;
        }

        .combat-action-overlay.shake {
            animation: screenShake 0.5s ease-in-out;
        }

        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px); }
            20%, 40%, 60%, 80% { transform: translate(5px, -5px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="combat-overlay" class="combat-action-overlay"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Game Constants
        const CLASSES = ['Warrior', 'Mage', 'Rogue', 'Cleric', 'Ranger'];
        const RACES = ['Human', 'Elf', 'Dwarf', 'Halfling', 'Dragonborn'];

        const CAMPAIGN_SCENARIOS = [
            {
                id: 1,
                name: "The Goblin Cave",
                description: "A band of goblins has been raiding nearby villages. Track them to their cave and end their threat.",
                enemies: [
                    { name: "Goblin Scout", hp: 15, maxHp: 15, ac: 13, attack: 5 },
                    { name: "Goblin Warrior", hp: 20, maxHp: 20, ac: 14, attack: 6 },
                    { name: "Goblin Chief", hp: 35, maxHp: 35, ac: 16, attack: 8 }
                ],
                xpReward: 100,
                goldReward: 50
            },
            {
                id: 2,
                name: "Ancient Ruins",
                description: "Mysterious ruins have been discovered. Explore them to uncover ancient secrets and treasures.",
                enemies: [
                    { name: "Skeleton", hp: 18, maxHp: 18, ac: 13, attack: 5 },
                    { name: "Zombie", hp: 25, maxHp: 25, ac: 12, attack: 6 },
                    { name: "Wraith", hp: 30, maxHp: 30, ac: 15, attack: 7 }
                ],
                xpReward: 150,
                goldReward: 75
            },
            {
                id: 3,
                name: "Dragon's Lair",
                description: "A young dragon has taken residence in the mountains. Defeat it before it becomes a true menace.",
                enemies: [
                    { name: "Kobold Minion", hp: 12, maxHp: 12, ac: 12, attack: 4 },
                    { name: "Kobold Shaman", hp: 20, maxHp: 20, ac: 13, attack: 6 },
                    { name: "Young Dragon", hp: 80, maxHp: 80, ac: 18, attack: 12 }
                ],
                xpReward: 300,
                goldReward: 200
            }
        ];

        // AI Bot Logic
        class AIBot {
            constructor(character) {
                this.character = character;
            }

            decideCombatAction(enemies, allies) {
                const aliveEnemies = enemies.filter(e => e.hp > 0);
                if (aliveEnemies.length === 0) return null;

                const roll = Math.random();
                const needsHealing = this.character.hp < this.character.maxHp * 0.3;

                if (needsHealing && roll < 0.3 && this.character.class === 'Cleric') {
                    return { type: 'special', target: this.character };
                }

                if (roll < 0.8) {
                    const target = aliveEnemies.reduce((weakest, current) =>
                        current.hp < weakest.hp ? current : weakest
                    );
                    return { type: 'attack', target };
                } else {
                    const target = aliveEnemies[Math.floor(Math.random() * aliveEnemies.length)];
                    return { type: 'special', target };
                }
            }
        }

        // Floating Damage Component
        function FloatingDamage({ damage, x, y, color }) {
            return (
                <div
                    className="floating-damage"
                    style={{
                        left: `${x}px`,
                        top: `${y}px`,
                        color: color
                    }}
                >
                    {damage}
                </div>
            );
        }

        // Character Creation Component
        function CharacterCreationModal({ onCreateCharacter, onCancel }) {
            const [name, setName] = useState('');
            const [race, setRace] = useState(RACES[0]);
            const [charClass, setCharClass] = useState(CLASSES[0]);

            return (
                <div className="modal">
                    <div className="modal-content">
                        <h2>‚öîÔ∏è Create Your Hero</h2>

                        <div className="form-group">
                            <label>Character Name:</label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="Enter a heroic name..."
                                autoFocus
                            />
                        </div>

                        <div className="form-group">
                            <label>Race:</label>
                            <select value={race} onChange={(e) => setRace(e.target.value)}>
                                {RACES.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                        </div>

                        <div className="form-group">
                            <label>Class:</label>
                            <select value={charClass} onChange={(e) => setCharClass(e.target.value)}>
                                {CLASSES.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>

                        <div className="modal-buttons">
                            <button className="btn btn-danger" onClick={onCancel}>
                                <span>Cancel</span>
                            </button>
                            <button
                                className="btn btn-success"
                                onClick={() => onCreateCharacter({name, race, class: charClass})}
                                disabled={!name}
                            >
                                <span>Create Hero</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [gameMode, setGameMode] = useState('menu');
            const [myPeerId, setMyPeerId] = useState('');
            const [remotePeerId, setRemotePeerId] = useState('');
            const [isHost, setIsHost] = useState(false);
            const [peer, setPeer] = useState(null);
            const [connection, setConnection] = useState(null);
            const [connectedPlayers, setConnectedPlayers] = useState([]);

            const [showCharacterCreation, setShowCharacterCreation] = useState(false);
            const [characters, setCharacters] = useState([]);
            const [currentScenario, setCurrentScenario] = useState(null);
            const [enemies, setEnemies] = useState([]);
            const [combatLog, setCombatLog] = useState([]);
            const [currentTurn, setCurrentTurn] = useState(0);
            const [inCombat, setInCombat] = useState(false);
            const [diceResult, setDiceResult] = useState(null);
            const [selectedTarget, setSelectedTarget] = useState(null);
            const [floatingDamages, setFloatingDamages] = useState([]);

            const peerRef = useRef(null);
            const connectionRef = useRef(null);
            const logEndRef = useRef(null);

            // Auto-scroll combat log
            useEffect(() => {
                logEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [combatLog]);

            // Initialize PeerJS
            useEffect(() => {
                if (gameMode === 'multiplayer' && !peer) {
                    const newPeer = new Peer();

                    newPeer.on('open', (id) => {
                        setMyPeerId(id);
                        console.log('My peer ID:', id);
                    });

                    newPeer.on('connection', (conn) => {
                        setupConnection(conn);
                        setConnectedPlayers(prev => [...prev, { id: conn.peer, name: 'Player' }]);
                    });

                    newPeer.on('error', (err) => {
                        console.error('Peer error:', err);
                        addLog('Connection error occurred', 'system');
                    });

                    setPeer(newPeer);
                    peerRef.current = newPeer;
                }

                return () => {
                    if (peerRef.current) {
                        peerRef.current.destroy();
                    }
                };
            }, [gameMode]);

            const setupConnection = (conn) => {
                conn.on('open', () => {
                    setConnection(conn);
                    connectionRef.current = conn;
                    addLog(`Connected to ${conn.peer}`, 'system');
                });

                conn.on('data', (data) => {
                    handleRemoteData(data);
                });

                conn.on('close', () => {
                    addLog('Player disconnected', 'system');
                    setConnection(null);
                });
            };

            const connectToPeer = () => {
                if (!peer || !remotePeerId) return;

                const conn = peer.connect(remotePeerId);
                setupConnection(conn);
            };

            const handleRemoteData = (data) => {
                console.log('Received data:', data);

                switch(data.type) {
                    case 'character_created':
                        setCharacters(prev => [...prev, data.character]);
                        addLog(`${data.character.name} joined the party!`, 'system');
                        break;
                    case 'combat_action':
                        addLog(data.message, 'combat');
                        break;
                    case 'scenario_start':
                        startScenario(data.scenario);
                        break;
                }
            };

            const sendData = (data) => {
                if (connectionRef.current && connectionRef.current.open) {
                    connectionRef.current.send(data);
                }
            };

            const addLog = (message, type = 'story') => {
                setCombatLog(prev => [...prev, { message, type, timestamp: Date.now() }]);
            };

            const rollDice = (sides) => {
                const result = Math.floor(Math.random() * sides) + 1;
                setDiceResult(result);
                setTimeout(() => setDiceResult(null), 2000);
                return result;
            };

            const showFloatingDamage = (damage, isHeal = false) => {
                const x = Math.random() * (window.innerWidth - 200) + 100;
                const y = Math.random() * (window.innerHeight - 200) + 100;
                const color = isHeal ? '#4ecdc4' : '#ff6b6b';
                const id = Date.now();

                setFloatingDamages(prev => [...prev, { id, damage: isHeal ? `+${damage}` : `-${damage}`, x, y, color }]);

                setTimeout(() => {
                    setFloatingDamages(prev => prev.filter(d => d.id !== id));
                }, 1500);
            };

            const shakeScreen = () => {
                const overlay = document.getElementById('combat-overlay');
                overlay.classList.add('shake');
                setTimeout(() => overlay.classList.remove('shake'), 500);
            };

            const createCharacter = (charData) => {
                const newChar = {
                    id: Date.now(),
                    ...charData,
                    hp: 100,
                    maxHp: 100,
                    level: 1,
                    xp: 0,
                    gold: 0,
                    inventory: ['Sword', 'Health Potion x3', 'Rope'],
                    isBot: gameMode === 'singleplayer' && characters.length > 0
                };

                newChar.stats = {
                    strength: rollDice(20),
                    dexterity: rollDice(20),
                    constitution: rollDice(20),
                    intelligence: rollDice(20),
                    wisdom: rollDice(20),
                    charisma: rollDice(20)
                };

                setCharacters(prev => [...prev, newChar]);
                setShowCharacterCreation(false);
                addLog(`${newChar.name} the ${newChar.race} ${newChar.class} has joined the adventure!`, 'system');

                if (gameMode === 'multiplayer' && connectionRef.current) {
                    sendData({ type: 'character_created', character: newChar });
                }

                if (gameMode === 'singleplayer' && characters.length === 0) {
                    setTimeout(() => createAIPartyMembers(), 500);
                }
            };

            const createAIPartyMembers = () => {
                const botNames = ['Thorin', 'Elara', 'Grimm'];
                const botClasses = ['Warrior', 'Mage', 'Cleric'];

                botNames.forEach((name, index) => {
                    const botChar = {
                        id: Date.now() + index,
                        name: name,
                        race: RACES[Math.floor(Math.random() * RACES.length)],
                        class: botClasses[index],
                        hp: 100,
                        maxHp: 100,
                        level: 1,
                        xp: 0,
                        gold: 0,
                        inventory: ['Sword', 'Health Potion x3'],
                        isBot: true,
                        stats: {
                            strength: rollDice(20),
                            dexterity: rollDice(20),
                            constitution: rollDice(20),
                            intelligence: rollDice(20),
                            wisdom: rollDice(20),
                            charisma: rollDice(20)
                        }
                    };

                    setCharacters(prev => [...prev, botChar]);
                    addLog(`${botChar.name} the ${botChar.race} ${botChar.class} has joined the party!`, 'system');
                });
            };

            const startScenario = (scenario) => {
                setCurrentScenario(scenario);
                setEnemies(scenario.enemies.map(e => ({...e, id: Math.random()})));
                setInCombat(true);
                setCurrentTurn(0);
                setSelectedTarget(null);
                addLog(`üó°Ô∏è ${scenario.name}: ${scenario.description}`, 'story');
                addLog('‚öîÔ∏è Combat begins!', 'combat');

                if (gameMode === 'multiplayer' && isHost && connectionRef.current) {
                    sendData({ type: 'scenario_start', scenario });
                }
            };

            const performAttack = (attacker, target) => {
                const attackRoll = rollDice(20);
                const damage = rollDice(8) + Math.floor(attacker.stats?.strength / 2 || 5);

                addLog(`${attacker.name} attacks ${target.name}!`, 'combat');
                addLog(`üé≤ Roll: ${attackRoll} + ${Math.floor(attacker.stats?.strength / 2 || 5)}`, 'combat');

                if (attackRoll + Math.floor(attacker.stats?.strength / 2 || 5) >= (target.ac || 10)) {
                    target.hp -= damage;
                    addLog(`üí• Hit! ${damage} damage dealt to ${target.name}!`, 'combat');
                    showFloatingDamage(damage);
                    shakeScreen();

                    if (target.hp <= 0) {
                        target.hp = 0;
                        addLog(`‚ò†Ô∏è ${target.name} has been defeated!`, 'combat');
                    }
                } else {
                    addLog(`‚ùå Miss! ${target.name} dodged the attack!`, 'combat');
                }

                updateCombatEntities(attacker, target);
                setSelectedTarget(null);
            };

            const performSpecialAbility = (character, target) => {
                const abilityRoll = rollDice(20);
                let damage = rollDice(12) + Math.floor(character.stats?.intelligence / 2 || 6);

                if (character.class === 'Mage') {
                    addLog(`${character.name} casts Fireball! üî•`, 'combat');
                    damage *= 1.5;
                } else if (character.class === 'Cleric') {
                    addLog(`${character.name} channels divine energy! ‚ú®`, 'combat');
                    character.hp = Math.min(character.hp + damage, character.maxHp);
                    addLog(`üíö ${character.name} heals for ${damage} HP!`, 'combat');
                    showFloatingDamage(damage, true);
                    updateCombatEntities(character, null);
                    setSelectedTarget(null);
                    return;
                } else if (character.class === 'Rogue') {
                    addLog(`${character.name} performs a sneak attack! üó°Ô∏è`, 'combat');
                    damage *= 2;
                }

                if (abilityRoll >= (target.ac || 10)) {
                    target.hp -= Math.floor(damage);
                    addLog(`‚ú® Critical hit! ${Math.floor(damage)} damage dealt!`, 'combat');
                    showFloatingDamage(Math.floor(damage));
                    shakeScreen();

                    if (target.hp <= 0) {
                        target.hp = 0;
                        addLog(`‚ò†Ô∏è ${target.name} has been defeated!`, 'combat');
                    }
                } else {
                    addLog(`‚ùå The ability missed!`, 'combat');
                }

                updateCombatEntities(character, target);
                setSelectedTarget(null);
            };

            const updateCombatEntities = (attacker, target) => {
                setCharacters(prev => prev.map(c =>
                    c.id === attacker.id ? {...attacker} : c
                ));

                if (target && target.id) {
                    setEnemies(prev => prev.map(e =>
                        e.id === target.id ? {...target} : e
                    ));
                }
            };

            const nextTurn = () => {
                const allCombatants = [...characters, ...enemies].filter(c => c.hp > 0);

                if (enemies.every(e => e.hp <= 0)) {
                    endCombat(true);
                    return;
                }

                if (characters.every(c => c.hp <= 0)) {
                    endCombat(false);
                    return;
                }

                const nextTurnIndex = (currentTurn + 1) % allCombatants.length;
                setCurrentTurn(nextTurnIndex);

                const currentCombatant = allCombatants[nextTurnIndex];
                addLog(`üéØ ${currentCombatant.name}'s turn!`, 'system');

                if (currentCombatant.isBot) {
                    setTimeout(() => {
                        const bot = new AIBot(currentCombatant);
                        const action = bot.decideCombatAction(enemies, characters);

                        if (action) {
                            if (action.type === 'attack') {
                                performAttack(currentCombatant, action.target);
                            } else {
                                performSpecialAbility(currentCombatant, action.target);
                            }
                            setTimeout(nextTurn, 1500);
                        }
                    }, 1000);
                }
            };

            const endCombat = (victory) => {
                setInCombat(false);

                if (victory) {
                    addLog(`üéâ Victory! The party has defeated all enemies!`, 'story');
                    const xp = currentScenario.xpReward;
                    const gold = currentScenario.goldReward;

                    setCharacters(prev => prev.map(c => ({
                        ...c,
                        xp: c.xp + xp,
                        gold: c.gold + gold,
                        hp: c.maxHp
                    })));

                    addLog(`‚≠ê Gained ${xp} XP and ${gold} gold!`, 'system');
                } else {
                    addLog(`üíÄ Defeat... The party has fallen.`, 'story');
                }

                setCurrentScenario(null);
                setEnemies([]);
                setSelectedTarget(null);
            };

            const renderMenu = () => (
                <div className="connection-panel">
                    <h2>Welcome, Adventurer!</h2>
                    <p style={{color: '#a0a0c0', marginBottom: '20px'}}>
                        Choose your path to embark on an epic quest
                    </p>
                    <div className="quick-actions">
                        <button
                            className="btn btn-primary"
                            onClick={() => {
                                setGameMode('singleplayer');
                                setShowCharacterCreation(true);
                            }}
                        >
                            <span>üéÆ Solo Adventure (with AI)</span>
                        </button>
                        <button
                            className="btn btn-success"
                            onClick={() => setGameMode('multiplayer')}
                        >
                            <span>üë• Multiplayer Quest</span>
                        </button>
                    </div>
                </div>
            );

            const renderMultiplayerSetup = () => (
                <div className="connection-panel">
                    <h2>Multiplayer Connection</h2>
                    <div className="connection-status">
                        <span className={myPeerId ? 'status-badge status-connected' : 'status-badge status-disconnected'}>
                            {myPeerId ? 'Connected' : 'Connecting...'}
                        </span>
                        {myPeerId && (
                            <span>Your ID: <strong>{myPeerId}</strong></span>
                        )}
                    </div>

                    <div className="connection-controls">
                        <div className="input-group">
                            <label>Connect to Peer ID:</label>
                            <input
                                type="text"
                                value={remotePeerId}
                                onChange={(e) => setRemotePeerId(e.target.value)}
                                placeholder="Enter peer ID..."
                            />
                        </div>
                        <button
                            className="btn btn-primary"
                            onClick={connectToPeer}
                            disabled={!myPeerId || !remotePeerId}
                        >
                            <span>Connect</span>
                        </button>
                        <button
                            className="btn btn-success"
                            onClick={() => {
                                setIsHost(true);
                                setShowCharacterCreation(true);
                            }}
                            disabled={!myPeerId}
                        >
                            <span>Host Game</span>
                        </button>
                    </div>

                    {connection && (
                        <div style={{marginTop: '20px'}}>
                            <button
                                className="btn btn-success"
                                onClick={() => setShowCharacterCreation(true)}
                            >
                                <span>Create Character</span>
                            </button>
                        </div>
                    )}
                </div>
            );

            const renderGame = () => {
                const allCombatants = [...characters, ...enemies].filter(c => c.hp > 0);
                const currentCombatant = allCombatants[currentTurn];

                return (
                    <div className="game-container">
                        {/* Left Panel - Party */}
                        <div className="panel">
                            <h3>‚öîÔ∏è Party Members</h3>
                            <div className="scroll-container">
                                {characters.map(char => (
                                    <div
                                        key={char.id}
                                        className={`player-card ${currentCombatant?.id === char.id ? 'active' : ''}`}
                                    >
                                        <div className="player-name">
                                            {char.name} {char.isBot && 'ü§ñ'}
                                        </div>
                                        <div className="player-info">
                                            Lv.{char.level} {char.race} {char.class}
                                        </div>
                                        <div className="health-bar">
                                            <div
                                                className="health-fill"
                                                style={{width: `${(char.hp / char.maxHp) * 100}%`}}
                                            >
                                                {char.hp}/{char.maxHp}
                                            </div>
                                        </div>
                                        <div style={{fontSize: '0.85em', color: '#a0a0c0', marginTop: '8px'}}>
                                            XP: {char.xp} | Gold: {char.gold} ü™ô
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {!showCharacterCreation && characters.length === 0 && (
                                <button
                                    className="btn btn-primary"
                                    onClick={() => setShowCharacterCreation(true)}
                                    style={{width: '100%', marginTop: '15px'}}
                                >
                                    <span>Create Character</span>
                                </button>
                            )}
                        </div>

                        {/* Center Panel - Campaign Log */}
                        <div className="panel">
                            <h3>üìú Campaign Log</h3>

                            {inCombat && currentCombatant && (
                                <div className="turn-indicator">
                                    üéØ {currentCombatant.name}'s Turn
                                </div>
                            )}

                            <div className="campaign-log scroll-container">
                                {combatLog.map((log, idx) => (
                                    <div key={idx} className={`log-entry ${log.type}`}>
                                        {log.message}
                                    </div>
                                ))}
                                <div ref={logEndRef} />
                            </div>

                            {diceResult && (
                                <div className="dice-result">
                                    üé≤ {diceResult}
                                </div>
                            )}

                            {!inCombat && characters.length > 0 && (
                                <div style={{marginTop: '20px'}}>
                                    <h3 style={{marginBottom: '15px'}}>üó∫Ô∏è Available Quests</h3>
                                    {CAMPAIGN_SCENARIOS.map(scenario => (
                                        <div key={scenario.id} className="quest-card">
                                            <div className="quest-title">{scenario.name}</div>
                                            <div className="quest-description">{scenario.description}</div>
                                            <div className="quest-reward">
                                                ‚≠ê Rewards: {scenario.xpReward} XP, {scenario.goldReward} Gold
                                            </div>
                                            <button
                                                className="btn btn-warning"
                                                onClick={() => startScenario(scenario)}
                                                style={{marginTop: '12px', width: '100%'}}
                                            >
                                                <span>Start Quest</span>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {inCombat && currentCombatant && !currentCombatant.isBot && (
                                <>
                                    <div className="combat-controls">
                                        <button
                                            className="btn btn-danger"
                                            onClick={() => {
                                                if (selectedTarget) {
                                                    performAttack(currentCombatant, selectedTarget);
                                                    setTimeout(nextTurn, 1000);
                                                } else {
                                                    addLog('‚ö†Ô∏è Select a target first!', 'system');
                                                }
                                            }}
                                            disabled={!selectedTarget}
                                        >
                                            <span>‚öîÔ∏è Attack</span>
                                        </button>
                                        <button
                                            className="btn btn-primary"
                                            onClick={() => {
                                                if (selectedTarget || currentCombatant.class === 'Cleric') {
                                                    performSpecialAbility(
                                                        currentCombatant,
                                                        currentCombatant.class === 'Cleric' ? currentCombatant : selectedTarget
                                                    );
                                                    setTimeout(nextTurn, 1000);
                                                } else {
                                                    addLog('‚ö†Ô∏è Select a target first!', 'system');
                                                }
                                            }}
                                            disabled={!selectedTarget && currentCombatant.class !== 'Cleric'}
                                        >
                                            <span>‚ú® Special Ability</span>
                                        </button>
                                    </div>
                                    {selectedTarget && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '10px',
                                            background: 'rgba(255, 217, 61, 0.1)',
                                            borderRadius: '8px',
                                            border: '1px solid rgba(255, 217, 61, 0.3)',
                                            textAlign: 'center',
                                            fontSize: '0.9em'
                                        }}>
                                            üéØ Target: <strong>{selectedTarget.name}</strong>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* Right Panel - Enemies/Info */}
                        <div className="panel">
                            <h3>üíÄ Combat Status</h3>
                            {inCombat && (
                                <div className="scroll-container">
                                    {enemies.map(enemy => (
                                        <div
                                            key={enemy.id}
                                            className={`enemy-card ${selectedTarget?.id === enemy.id ? 'selected' : ''} ${enemy.hp <= 0 ? 'defeated' : ''}`}
                                            onClick={() => {
                                                if (enemy.hp > 0 && currentCombatant && !currentCombatant.isBot) {
                                                    setSelectedTarget(enemy);
                                                }
                                            }}
                                        >
                                            <div className="enemy-name">{enemy.name}</div>
                                            <div className="health-bar">
                                                <div
                                                    className="health-fill"
                                                    style={{width: `${(enemy.hp / enemy.maxHp) * 100}%`}}
                                                >
                                                    {enemy.hp}/{enemy.maxHp}
                                                </div>
                                            </div>
                                            <div className="enemy-stats">
                                                <span>üõ°Ô∏è AC: {enemy.ac}</span>
                                                <span>‚öîÔ∏è ATK: +{enemy.attack}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {!inCombat && (
                                <div style={{padding: '30px 20px', textAlign: 'center', color: '#6c6c8c'}}>
                                    <div style={{fontSize: '3em', marginBottom: '10px'}}>‚öîÔ∏è</div>
                                    <div>No active combat</div>
                                    <div style={{fontSize: '0.9em', marginTop: '8px'}}>
                                        Select a quest to begin your adventure!
                                    </div>
                                </div>
                            )}

                            <div className="dice-roller">
                                <h3 style={{marginBottom: '15px'}}>üé≤ Dice Roller</h3>
                                <div className="action-buttons">
                                    {[4, 6, 8, 10, 12, 20].map(sides => (
                                        <button
                                            key={sides}
                                            className="btn btn-primary"
                                            onClick={() => rollDice(sides)}
                                        >
                                            <span>d{sides}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>‚öîÔ∏è D&D Campaign Manager ‚öîÔ∏è</h1>
                        <p>Embark on epic adventures with friends or AI companions</p>
                    </div>

                    {gameMode === 'menu' && renderMenu()}
                    {gameMode === 'multiplayer' && !connection && !showCharacterCreation && renderMultiplayerSetup()}
                    {(gameMode === 'singleplayer' || connection || characters.length > 0) && renderGame()}
                    {showCharacterCreation && (
                        <CharacterCreationModal
                            onCreateCharacter={createCharacter}
                            onCancel={() => setShowCharacterCreation(false)}
                        />
                    )}

                    {floatingDamages.map(dmg => (
                        <FloatingDamage key={dmg.id} {...dmg} />
                    ))}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
