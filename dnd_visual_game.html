<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baldur's Gate Chronicles - Enhanced Edition ‚öîÔ∏è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');

        :root {
            --gold: #f4d03f;
            --dark-gold: #c5a747;
            --crimson: #c41e3a;
            --dark-bg: #1a0f0a;
            --panel-bg: rgba(30, 20, 15, 0.95);
            --success: #4ade80;
            --fail: #ef4444;
        }

        body {
            font-family: 'Lora', Georgia, serif;
            background: radial-gradient(ellipse at center, #1a0f0a 0%, #0a0505 100%);
            color: #f0e6d2;
            overflow: hidden;
            user-select: none;
        }

        /* CONSENSUS: Enhanced Tutorial Overlay */
        #tutorialOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.92);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tutorialContent {
            background: linear-gradient(135deg, rgba(60, 40, 30, 0.98) 0%, rgba(30, 20, 15, 0.98) 100%);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9), 0 0 100px rgba(244, 208, 63, 0.4);
        }

        .tutorialContent h2 {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(244, 208, 63, 0.8);
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 20px rgba(244, 208, 63, 0.8); }
            50% { text-shadow: 0 0 40px rgba(255, 215, 0, 1); }
        }

        .tutorialContent p {
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 30px;
            color: #e8dcc4;
        }

        .tutorialButton {
            padding: 15px 40px;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.95) 100%);
            border: 2px solid var(--dark-gold);
            color: #f4e4c1;
            font-family: 'Cinzel', serif;
            font-size: 1.1em;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s;
            margin: 0 10px;
        }

        .tutorialButton:hover {
            transform: translateY(-3px);
            border-color: var(--gold);
            box-shadow: 0 8px 25px rgba(244, 208, 63, 0.5);
        }

        .tutorialButton:focus {
            outline: 3px solid var(--gold);
            outline-offset: 2px;
        }

        /* CONSENSUS: XP Progress Bar */
        .xpBar {
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 24px;
            border: 2px solid var(--dark-gold);
            overflow: hidden;
            position: relative;
        }

        .xpFill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.6);
        }

        .xpText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: 700;
            color: #fff;
            text-shadow: 2px 2px 4px #000;
            font-family: 'Cinzel', serif;
        }

        /* Game Container */
        #gameContainer {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        #visualSection {
            flex: 1;
            position: relative;
            border-right: 3px solid rgba(244, 208, 63, 0.3);
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #2a1810 0%, #0f0808 100%);
        }

        #modeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.95) 100%);
            border: 2px solid var(--gold);
            color: #f4e4c1;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.7);
            transition: all 0.3s;
            z-index: 100;
        }

        #modeToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 208, 63, 0.5);
        }

        #textSection {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--panel-bg) 0%, rgba(20, 15, 10, 0.98) 100%);
            backdrop-filter: blur(10px);
        }

        #narrativeBox {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            font-size: 1.1em;
            line-height: 1.8;
            color: #e8dcc4;
        }

        #narrativeBox::-webkit-scrollbar {
            width: 12px;
        }

        #narrativeBox::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        #narrativeBox::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b5a3c, #654321);
            border-radius: 6px;
        }

        .narrativeText {
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: textReveal 0.8s ease-out;
        }

        @keyframes textReveal {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .narrativeTitle {
            font-family: 'Cinzel', serif;
            font-size: 1.8em;
            color: var(--gold);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(244, 208, 63, 0.6);
            animation: titleGlow 3s ease-in-out infinite;
        }

        .combatText {
            background: rgba(196, 30, 58, 0.15);
            padding: 15px;
            border-left: 4px solid var(--crimson);
            margin: 15px 0;
            border-radius: 4px;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .diceRoll {
            display: inline-block;
            background: linear-gradient(135deg, #4a2511, #8b4513);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #ffd700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: diceShake 0.5s;
        }

        @keyframes diceShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .successText {
            color: var(--success);
            font-weight: 600;
            animation: successPulse 0.5s;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .failText {
            color: var(--fail);
            font-weight: 600;
            animation: failShake 0.5s;
        }

        @keyframes failShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .initiativeTracker {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
        }

        .initiativeEntry {
            display: flex;
            align-items: center;
            padding: 5px;
            margin: 3px 0;
            background: rgba(197, 167, 71, 0.15);
            border-radius: 4px;
            gap: 10px;
        }

        .initiativeEntry.active {
            background: rgba(244, 208, 63, 0.3);
            border: 1px solid var(--gold);
        }

        .statusEffect {
            display: inline-block;
            padding: 2px 8px;
            margin: 0 3px;
            background: rgba(70, 130, 180, 0.3);
            border-radius: 3px;
            font-size: 0.85em;
            color: #87ceeb;
        }

        #choiceBox {
            padding: 30px;
            border-top: 2px solid rgba(244, 208, 63, 0.3);
            background: linear-gradient(135deg, rgba(40, 25, 15, 0.95) 0%, rgba(20, 15, 10, 0.98) 100%);
        }

        .choice {
            display: block;
            width: 100%;
            padding: 18px 25px;
            margin: 12px 0;
            background: linear-gradient(135deg, rgba(60, 40, 25, 0.9) 0%, rgba(40, 25, 15, 0.95) 100%);
            border: 2px solid rgba(197, 167, 71, 0.6);
            border-radius: 10px;
            color: #f4e4c1;
            font-family: 'Lora', serif;
            font-size: 1.05em;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .choice::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transition: left 0.5s;
        }

        .choice:hover::before {
            left: 100%;
        }

        .choice:hover {
            background: linear-gradient(135deg, rgba(100, 65, 40, 0.95) 0%, rgba(60, 40, 25, 0.98) 100%);
            border-color: var(--gold);
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(244, 208, 63, 0.4);
        }

        .choice:focus {
            outline: 3px solid var(--gold);
            outline-offset: 2px;
        }

        .choiceLabel {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--gold);
        }

        .choiceDescription {
            font-size: 0.95em;
            color: #c0b090;
        }

        .choiceSkill {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            background: rgba(70, 130, 180, 0.3);
            border-radius: 4px;
            font-size: 0.9em;
            color: #87ceeb;
        }

        #charPanel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: linear-gradient(135deg, rgba(30, 20, 10, 0.95) 0%, rgba(20, 15, 5, 0.98) 100%);
            border: 2px solid rgba(244, 208, 63, 0.4);
            border-radius: 12px;
            padding: 15px;
            min-width: 260px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 50;
        }

        #charPanel::-webkit-scrollbar {
            width: 8px;
        }

        #charPanel::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b5a3c, #654321);
            border-radius: 4px;
        }

        .charCard {
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            border: 1px solid rgba(197, 167, 71, 0.5);
            transition: all 0.3s;
        }

        .charCard:hover {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(244, 208, 63, 0.3);
        }

        .charName {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .charClass {
            font-size: 0.9em;
            color: #c0c0c0;
            margin-bottom: 8px;
        }

        .healthBar {
            height: 18px;
            background: rgba(20, 5, 5, 0.9);
            border-radius: 9px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(196, 30, 58, 0.5);
            margin-bottom: 5px;
        }

        .healthFill {
            height: 100%;
            background: linear-gradient(90deg, #c41e3a, #ef4444);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .healthText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }

        .charStats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .statBox {
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }

        .statLabel {
            color: var(--dark-gold);
            font-weight: 600;
        }

        .statValue {
            color: #f4e4c1;
            font-weight: 700;
        }

        #mainMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(60, 40, 30, 0.98) 0%, rgba(30, 20, 15, 0.98) 100%);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9), 0 0 100px rgba(244, 208, 63, 0.3);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        #mainMenu h1 {
            font-family: 'Cinzel', serif;
            color: #f4e4c1;
            font-size: 3em;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(244, 208, 63, 0.8);
            animation: titleGlow 3s ease-in-out infinite;
        }

        #mainMenu h2 {
            color: #c0c0c0;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .menuButton {
            display: block;
            width: 300px;
            padding: 18px;
            margin: 15px auto;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.95) 100%);
            border: 2px solid var(--dark-gold);
            color: #f4e4c1;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .menuButton:hover {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.95) 0%, rgba(139, 69, 19, 0.98) 100%);
            transform: translateY(-3px);
            border-color: var(--gold);
            box-shadow: 0 8px 25px rgba(244, 208, 63, 0.5);
        }

        .menuButton:focus {
            outline: 3px solid var(--gold);
            outline-offset: 2px;
        }

        .dataControls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .dataControls button {
            margin-right: 10px;
            padding: 10px 20px;
            background: rgba(40, 25, 15, 0.9);
            border: 2px solid rgba(244, 208, 63, 0.5);
            color: #f4e4c1;
            font-family: 'Cinzel', serif;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dataControls button:hover {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(244, 208, 63, 0.4);
        }

        .dataControls button:focus {
            outline: 3px solid var(--gold);
            outline-offset: 2px;
        }

        .damageNumber {
            position: absolute;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 2em;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 1.5s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        @media (max-width: 1024px) {
            #gameContainer {
                flex-direction: column;
            }

            #visualSection {
                height: 40vh;
                border-right: none;
                border-bottom: 3px solid rgba(244, 208, 63, 0.3);
            }

            #textSection {
                height: 60vh;
            }

            #charPanel {
                top: 10px;
                left: 10px;
                min-width: 180px;
                padding: 10px;
                max-height: 35vh;
            }

            #narrativeBox {
                padding: 20px;
                font-size: 1em;
            }

            #choiceBox {
                padding: 20px;
            }

            .menuButton {
                width: 250px;
                font-size: 1em;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .hide {
            display: none !important;
        }

        /* CONSENSUS: Level up notification */
        .levelUpNotif {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.3), rgba(34, 197, 94, 0.3));
            border: 2px solid #4ade80;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            animation: levelUpGlow 2s ease-in-out infinite;
        }

        @keyframes levelUpGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); }
            50% { box-shadow: 0 0 40px rgba(74, 222, 128, 0.8); }
        }
    </style>
</head>
<body>
    <div id="tutorialOverlay" style="display: none;">
        <div class="tutorialContent">
            <h2>‚öîÔ∏è Welcome, Adventurer! ‚öîÔ∏è</h2>
            <p>You are about to embark on a perilous journey through the cursed lands of Ravenloft. Your choices matter, your dice rolls determine fate, and glory awaits the brave.</p>
            <p><strong>Controls:</strong><br>
            ‚Ä¢ Click choices to make decisions<br>
            ‚Ä¢ Use keyboard (1-4) for quick selections<br>
            ‚Ä¢ Press ESC to close dialogs<br>
            ‚Ä¢ Export/Import to save your progress</p>
            <button class="tutorialButton" onclick="game.startTutorial()" tabindex="0">Start Tutorial</button>
            <button class="tutorialButton" onclick="game.skipTutorial()" tabindex="0">Skip to Adventure</button>
        </div>
    </div>

    <div class="dataControls">
        <button onclick="exportData()" aria-label="Export game save" tabindex="0">üíæ Export Save</button>
        <button onclick="document.getElementById('importFile').click()" aria-label="Import game save" tabindex="0">üìÅ Import Save</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
    </div>

    <div id="gameContainer">
        <div id="visualSection">
            <canvas id="renderCanvas"></canvas>
            <button id="modeToggle" onclick="game.toggleViewMode()" aria-label="Toggle between 2D and 3D view" tabindex="0">2D View</button>
            <div id="charPanel" role="region" aria-label="Party information"></div>
        </div>

        <div id="textSection">
            <div id="narrativeBox" role="main" aria-live="polite" aria-atomic="true"></div>
            <div id="choiceBox" role="navigation" aria-label="Available choices"></div>
        </div>
    </div>

    <div id="mainMenu">
        <h1>‚öîÔ∏è Baldur's Gate Chronicles ‚öîÔ∏è</h1>
        <h2>Enhanced Edition v3.0</h2>
        <button class="menuButton" onclick="game.newGame()" tabindex="0">üó°Ô∏è New Adventure</button>
        <button class="menuButton" onclick="game.continueGame()" tabindex="0">üìú Continue</button>
        <button class="menuButton" onclick="game.showSettings()" tabindex="0">‚öôÔ∏è Settings</button>
    </div>

    <script>
        const APP_NAME = 'baldurs-gate-chronicles-enhanced-v3';

        // CONSENSUS: Performance - Optimized DOM caching
        const DOMCache = {};
        function getElement(id) {
            if (!DOMCache[id]) {
                DOMCache[id] = document.getElementById(id);
            }
            return DOMCache[id];
        }

        // CONSENSUS: Enhanced game state with XP tracking and relationships
        let gameState = {
            currentScene: 'intro',
            characters: [],
            choices: {},
            inventory: [],
            viewMode: '2d',
            tutorial: false,
            xp: 0,
            level: 1,
            xpToNextLevel: 300,
            relationships: {
                elara: 0,
                thorin: 0,
                lyra: 0
            },
            combat: {
                active: false,
                round: 0,
                initiative: [],
                currentTurn: 0,
                statusEffects: new Map()
            },
            settings: {
                difficulty: 'normal',
                reducedMotion: false
            }
        };

        // CONSENSUS: Expanded item database
        const ITEMS = {
            health_potion: {
                name: 'Health Potion',
                description: 'Restores 2d4+2 HP',
                rarity: 'common',
                icon: 'üß™',
                effect: { type: 'heal', amount: '2d4+2' }
            },
            greater_health_potion: {
                name: 'Greater Health Potion',
                description: 'Restores 4d4+4 HP',
                rarity: 'uncommon',
                icon: '‚ú®',
                effect: { type: 'heal', amount: '4d4+4' }
            },
            magic_sword: {
                name: 'Longsword +1',
                description: '+1 to attack and damage rolls',
                rarity: 'uncommon',
                icon: '‚öîÔ∏è',
                effect: { type: 'weapon', bonus: 1 }
            },
            ring_of_protection: {
                name: 'Ring of Protection',
                description: '+1 to AC and saving throws',
                rarity: 'rare',
                icon: 'üíç',
                effect: { type: 'ac', bonus: 1 }
            },
            scroll_of_fireball: {
                name: 'Scroll of Fireball',
                description: 'Cast Fireball (8d6 damage)',
                rarity: 'uncommon',
                icon: 'üìú',
                effect: { type: 'spell', spell: 'fireball', damage: '8d6' }
            },
            sunblade_shard: {
                name: 'Sunblade Shard',
                description: 'A fragment of the legendary Sunblade',
                rarity: 'legendary',
                icon: '‚ú®',
                quest: true
            }
        };

        // CONSENSUS: Fixed all broken scene references + added missing scenes
        const SCENES = {
            intro: {
                title: "üåÑ The Road to Thornhaven",
                text: `The late afternoon sun casts long shadows across the dirt road. You and your companions have been traveling for three days, and the small village of Thornhaven should be just over the next hill.

<strong>Your companions are:</strong>
‚Ä¢ <strong style="color: #f4d03f">Elara</strong>, a wise cleric of the light, her staff glowing faintly with divine energy
‚Ä¢ <strong style="color: #8b4513">Thorin</strong>, a stalwart dwarf fighter, his greataxe strapped to his back
‚Ä¢ <strong style="color: #9370db">Lyra</strong>, a nimble half-elf rogue, constantly scanning the treeline for threats

As you crest the hill, you see smoke rising from the village ahead. The sounds of screaming and clashing steel drift on the wind.

<em>"We need to move, now!"</em> Elara shouts, already starting down the hill.`,
                sceneData: {
                    environment: 'road_forest',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'alert'},
                        {id: 'elara', x: 200, y: 280, state: 'concerned'},
                        {id: 'thorin', x: 300, y: 300, state: 'ready'},
                        {id: 'lyra', x: 230, y: 250, state: 'scouting'}
                    ]
                },
                choices: [
                    {
                        id: 'rush_village',
                        label: "‚öîÔ∏è Rush to the village!",
                        description: "Charge ahead to help the villagers. Time is of the essence!",
                        nextScene: 'goblin_attack'
                    },
                    {
                        id: 'scout_first',
                        label: "üëÅÔ∏è Send Lyra to scout ahead",
                        description: "Better to know what you're dealing with before rushing in.",
                        skill: 'Stealth',
                        dc: 12,
                        success: 'scout_success',
                        failure: 'scout_failure'
                    },
                    {
                        id: 'prepare',
                        label: "‚ú® Take a moment to prepare",
                        description: "Cast protective spells and ready weapons before proceeding.",
                        nextScene: 'prepare_scene'
                    }
                ]
            },

            prepare_scene: {
                title: "‚ö° Preparation",
                text: `You halt your party at the hilltop. "Wait," you command. "We go in prepared."

Elara nods approvingly and begins chanting, her staff glowing brighter. <em>"Bless you with the light's protection..."</em> Divine energy washes over your group.

<div class="combatText">
<strong>‚≠ê Elara casts Bless!</strong><br>
All party members gain +1d4 to attack rolls and saving throws for 1 minute.<br>
<span class="statusEffect">üõ°Ô∏è Blessed</span>
</div>

Thorin checks his greataxe, ensuring the blade is sharp. Lyra strings her bow and counts her arrows.

<em>"We're ready,"</em> Thorin growls, determination burning in his eyes.`,
                sceneData: {
                    environment: 'road_forest',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'buffed'},
                        {id: 'elara', x: 200, y: 280, state: 'casting'},
                        {id: 'thorin', x: 300, y: 300, state: 'ready'},
                        {id: 'lyra', x: 230, y: 250, state: 'ready'}
                    ]
                },
                choices: [
                    {
                        id: 'advance_prepared',
                        label: "‚öîÔ∏è Advance to the village",
                        description: "Move forward with your preparations complete (+1d4 to first attack).",
                        nextScene: 'goblin_attack_prepared'
                    }
                ]
            },

            scout_success: {
                title: "üéØ Successful Reconnaissance",
                text: `Lyra disappears into the shadows, moving with practiced silence. Minutes later, she returns, slightly out of breath.

<em>"Five goblins,"</em> she reports. <em>"Three in the square terrorizing villagers, two more ransacking the general store. They're disorganized - we have the element of surprise."</em>

She sketches a quick map in the dirt. <em>"We can flank them from the east through the alley, or take the direct approach and divide their attention."</em>

<div class="combatText">
<strong>‚úÖ Scout Successful!</strong><br>
‚Ä¢ You gain <strong>advantage</strong> on your first attack in combat<br>
‚Ä¢ Party gains tactical positioning bonus (+2 initiative)<br>
‚Ä¢ Enemy positions revealed
</div>`,
                sceneData: {
                    environment: 'road_forest',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300},
                        {id: 'elara', x: 200, y: 280},
                        {id: 'thorin', x: 300, y: 300},
                        {id: 'lyra', x: 230, y: 250, state: 'reporting'}
                    ]
                },
                choices: [
                    {
                        id: 'flank_attack',
                        label: "üó°Ô∏è Use the flanking route",
                        description: "Sneak through the alley for a devastating surprise attack.",
                        nextScene: 'goblin_attack_flanked'
                    },
                    {
                        id: 'direct_assault',
                        label: "‚öîÔ∏è Direct assault",
                        description: "Charge in from the front and split their forces.",
                        nextScene: 'goblin_attack'
                    }
                ]
            },

            scout_failure: {
                title: "‚ö†Ô∏è Alert!",
                text: `Lyra moves down the hill, but a twig snaps under her boot with a sharp <strong>CRACK!</strong>

<em>"INTRUDERS!"</em> A goblin voice shrieks from the village. An alarm horn blares through the valley.

<em>"So much for stealth,"</em> Lyra mutters, drawing her bow with a grimace. <em>"They know we're coming now!"</em>

<div class="combatText">
<strong>‚ùå Scout Failed!</strong><br>
‚Ä¢ Goblins are alerted and gain +2 to initiative<br>
‚Ä¢ Two additional goblin reinforcements arrive!<br>
‚Ä¢ You lose the element of surprise
</div>`,
                sceneData: {
                    environment: 'road_forest',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'alert'},
                        {id: 'elara', x: 200, y: 280, state: 'concerned'},
                        {id: 'thorin', x: 300, y: 300, state: 'ready'},
                        {id: 'lyra', x: 230, y: 250, state: 'embarrassed'}
                    ]
                },
                choices: [
                    {
                        id: 'charge_anyway',
                        label: "‚öîÔ∏è Charge into combat!",
                        description: "No turning back now! Face them head-on!",
                        nextScene: 'goblin_attack_hard'
                    }
                ]
            },

            goblin_attack: {
                title: "‚öîÔ∏è Goblins in the Square!",
                text: `You burst into the village square to find chaos. Three goblins are ransacking homes and terrorizing fleeing villagers.

‚Ä¢ A sword-wielding <strong style="color: #4ade80">goblin warrior</strong> cackles maniacally
‚Ä¢ A <strong style="color: #86efac">goblin archer</strong> clutches a crude bow
‚Ä¢ A torch-wielding <strong style="color: #6ee7b7">goblin pyro</strong> attempts to set buildings ablaze

They spot you immediately.

<em>"More adventurers!"</em> the warrior goblin screeches. <em>"Kill them! Kill them all!"</em>

<div class="combatText">
<strong>‚öîÔ∏è COMBAT INITIATED!</strong><br>
Rolling initiative for all combatants...
</div>`,
                sceneData: {
                    environment: 'village_square',
                    combat: true,
                    partyPositions: [
                        {id: 'player', x: 150, y: 300},
                        {id: 'elara', x: 120, y: 270},
                        {id: 'thorin', x: 180, y: 300},
                        {id: 'lyra', x: 140, y: 250}
                    ],
                    enemies: [
                        {id: 'goblin1', type: 'Goblin Warrior', x: 400, y: 280, hp: 7, maxHp: 7, ac: 13},
                        {id: 'goblin2', type: 'Goblin Archer', x: 450, y: 250, hp: 5, maxHp: 5, ac: 12},
                        {id: 'goblin3', type: 'Goblin Pyro', x: 420, y: 320, hp: 5, maxHp: 5, ac: 11}
                    ]
                },
                choices: [
                    {
                        id: 'aggressive_attack',
                        label: "‚ö° Aggressive stance!",
                        description: "Attack with full force. +2 damage, -1 AC this round.",
                        combat: {type: 'aggressive'},
                        nextScene: 'combat_round_1'
                    },
                    {
                        id: 'defensive_stance',
                        label: "üõ°Ô∏è Defensive formation!",
                        description: "Take defensive positions. +2 AC, -1 damage this round.",
                        combat: {type: 'defensive'},
                        nextScene: 'combat_round_1'
                    },
                    {
                        id: 'intimidate',
                        label: "üò† Try to intimidate them",
                        description: "Roar a challenge and try to frighten the goblins into fleeing.",
                        skill: 'Intimidation',
                        dc: 13,
                        success: 'goblins_flee',
                        failure: 'combat_round_1'
                    }
                ]
            },

            // CONSENSUS FIX: Added missing goblin_attack variants
            goblin_attack_prepared: {
                title: "‚öîÔ∏è Blessed Assault!",
                text: `With Elara's blessing empowering you, your party charges into the village square with divine radiance surrounding you!

The three goblins freeze momentarily, startled by the golden aura.

<div class="combatText">
<strong>‚≠ê BLESSED ADVANTAGE!</strong><br>
Your preparation gives you the upper hand! +1d4 to all attack rolls this combat!
</div>`,
                sceneData: {
                    environment: 'village_square',
                    combat: true,
                    partyPositions: [
                        {id: 'player', x: 150, y: 300},
                        {id: 'elara', x: 120, y: 270},
                        {id: 'thorin', x: 180, y: 300},
                        {id: 'lyra', x: 140, y: 250}
                    ],
                    enemies: [
                        {id: 'goblin1', type: 'Goblin Warrior', x: 400, y: 280, hp: 7, maxHp: 7, ac: 13},
                        {id: 'goblin2', type: 'Goblin Archer', x: 450, y: 250, hp: 5, maxHp: 5, ac: 12},
                        {id: 'goblin3', type: 'Goblin Pyro', x: 420, y: 320, hp: 5, maxHp: 5, ac: 11}
                    ]
                },
                choices: [
                    {
                        id: 'strike_swift',
                        label: "‚ö° Strike swiftly!",
                        description: "Use your blessed advantage to end this quickly!",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            goblin_attack_flanked: {
                title: "üó°Ô∏è Flanking Maneuver!",
                text: `You silently navigate through the alley, emerging behind the unsuspecting goblins. They're completely focused on terrorizing villagers!

<div class="combatText">
<strong>‚úÖ FLANKING SUCCESS!</strong><br>
‚Ä¢ Surprise round activated!<br>
‚Ä¢ All allies attack first before goblins react<br>
‚Ä¢ +5 bonus to first attack roll!
</div>

Thorin grins wickedly. <em>"This is going to be good..."</em>`,
                sceneData: {
                    environment: 'village_square',
                    combat: true,
                    partyPositions: [
                        {id: 'player', x: 380, y: 300},
                        {id: 'elara', x: 350, y: 270},
                        {id: 'thorin', x: 410, y: 300},
                        {id: 'lyra', x: 365, y: 250}
                    ],
                    enemies: [
                        {id: 'goblin1', type: 'Goblin Warrior', x: 200, y: 280, hp: 7, maxHp: 7, ac: 13},
                        {id: 'goblin2', type: 'Goblin Archer', x: 150, y: 250, hp: 5, maxHp: 5, ac: 12},
                        {id: 'goblin3', type: 'Goblin Pyro', x: 180, y: 320, hp: 5, maxHp: 5, ac: 11}
                    ]
                },
                choices: [
                    {
                        id: 'ambush_strike',
                        label: "üí• Devastating ambush!",
                        description: "Attack from behind with overwhelming force!",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            goblin_attack_hard: {
                title: "‚öîÔ∏è Overwhelming Odds!",
                text: `You charge into the village square, but the goblins were ready. FIVE goblins turn to face you, weapons drawn!

<div class="combatText">
<strong>‚ö†Ô∏è DIFFICULT ENCOUNTER!</strong><br>
‚Ä¢ 5 goblins vs 4 party members<br>
‚Ä¢ Enemies prepared for combat (+2 AC)<br>
‚Ä¢ This will be challenging!
</div>

<em>"Stand together!"</em> Elara shouts. <em>"We can do this!"</em>`,
                sceneData: {
                    environment: 'village_square',
                    combat: true,
                    partyPositions: [
                        {id: 'player', x: 150, y: 300},
                        {id: 'elara', x: 120, y: 270},
                        {id: 'thorin', x: 180, y: 300},
                        {id: 'lyra', x: 140, y: 250}
                    ],
                    enemies: [
                        {id: 'goblin1', type: 'Goblin Warrior', x: 400, y: 280, hp: 7, maxHp: 7, ac: 15},
                        {id: 'goblin2', type: 'Goblin Archer', x: 450, y: 250, hp: 5, maxHp: 5, ac: 14},
                        {id: 'goblin3', type: 'Goblin Pyro', x: 420, y: 320, hp: 5, maxHp: 5, ac: 13},
                        {id: 'goblin4', type: 'Goblin Scout', x: 380, y: 310, hp: 4, maxHp: 4, ac: 14},
                        {id: 'goblin5', type: 'Goblin Bruiser', x: 430, y: 290, hp: 10, maxHp: 10, ac: 15}
                    ]
                },
                choices: [
                    {
                        id: 'fight_hard',
                        label: "‚öîÔ∏è Fight with everything you have!",
                        description: "This will be tough, but you must prevail!",
                        nextScene: 'combat_round_1'
                    }
                ]
            },

            combat_round_1: {
                title: "‚öîÔ∏è Battle in the Square - Round 1",
                combat: true,
                text: `<div class="initiativeTracker">
<strong>üé≤ Initiative Order:</strong>
<div class="initiativeEntry active">
<span class="diceRoll">18</span> <strong style="color: #8b4513">Thorin</strong> <span class="statusEffect">‚öîÔ∏è TURN</span>
</div>
<div class="initiativeEntry">
<span class="diceRoll">16</span> <strong style="color: #9370db">Lyra</strong>
</div>
<div class="initiativeEntry">
<span class="diceRoll">14</span> <strong style="color: #4ade80">Goblin Archer</strong>
</div>
<div class="initiativeEntry">
<span class="diceRoll">12</span> <strong style="color: #4682b4">You</strong>
</div>
<div class="initiativeEntry">
<span class="diceRoll">10</span> <strong style="color: #f4d03f">Elara</strong>
</div>
<div class="initiativeEntry">
<span class="diceRoll">8</span> <strong style="color: #4ade80">Goblin Warrior</strong>
</div>
<div class="initiativeEntry">
<span class="diceRoll">6</span> <strong style="color: #6ee7b7">Goblin Pyro</strong>
</div>
</div>

<div class="combatText">
<strong>‚öîÔ∏è Thorin's Turn:</strong><br>
Thorin charges forward with a mighty dwarven war cry, his greataxe gleaming!

<strong>Action:</strong> Attack (Goblin Warrior)<br>
Attack roll: <span class="diceRoll">d20(15) + 5 = 20</span> vs AC 13 - <span class="successText">‚úì HIT!</span><br>
Damage: <span class="diceRoll">d12(9) + 3 = 12</span>

The massive blade bites deep into the goblin's shoulder! Blood sprays as the creature crumples.<br>
<strong>Goblin Warrior: -12 HP ‚Üí üíÄ SLAIN!</strong>

<em>"One down!"</em> Thorin roars triumphantly!
</div>

<div class="combatText">
<strong>üèπ Lyra's Turn:</strong><br>
Lyra draws her shortbow with practiced grace and fires at the archer!

<strong>Action:</strong> Attack with Shortbow (Goblin Archer)<br>
Attack roll: <span class="diceRoll">d20(12) + 6 = 18</span> vs AC 12 - <span class="successText">‚úì HIT!</span><br>
Damage: <span class="diceRoll">d6(4) + 4 = 8</span>

The arrow strikes true, piercing the goblin's heart!<br>
<strong>Goblin Archer: -8 HP ‚Üí üíÄ DEAD!</strong>

<em>"Two down!"</em> Lyra calls out, already nocking another arrow.
</div>

<div class="combatText">
<strong>üéØ YOUR TURN!</strong><br>
Only the torch-wielding goblin remains, frantically trying to set the village well on fire!

What do you do?
</div>`,
                sceneData: {
                    environment: 'village_square',
                    combat: true,
                    round: 1,
                    partyPositions: [
                        {id: 'player', x: 200, y: 300},
                        {id: 'elara', x: 150, y: 270},
                        {id: 'thorin', x: 350, y: 290, state: 'bloodied'},
                        {id: 'lyra', x: 180, y: 240}
                    ],
                    enemies: [
                        {id: 'goblin3', type: 'Goblin Pyro', x: 420, y: 300, hp: 5, maxHp: 5, ac: 11}
                    ]
                },
                choices: [
                    {
                        id: 'attack_pyro',
                        label: "‚öîÔ∏è Attack the remaining goblin",
                        description: "Finish off the last enemy with your weapon!",
                        nextScene: 'combat_victory'
                    },
                    {
                        id: 'save_well',
                        label: "üíß Stop the goblin from burning the well",
                        description: "The village needs that water supply! (Athletics DC 10)",
                        skill: 'Athletics',
                        dc: 10,
                        success: 'well_saved',
                        failure: 'well_burning'
                    },
                    {
                        id: 'use_spell',
                        label: "‚ú® Cast a spell",
                        description: "Use magic to end this quickly (Magic Missile - auto-hit)",
                        nextScene: 'spell_finish'
                    },
                    {
                        id: 'capture',
                        label: "üéØ Try to capture it alive",
                        description: "It might have information! (Athletics DC 14)",
                        skill: 'Athletics',
                        dc: 14,
                        success: 'goblin_captured',
                        failure: 'combat_victory'
                    }
                ]
            },

            // CONSENSUS FIX: Added all missing scene references
            well_saved: {
                title: "üíß Water Preserved!",
                text: `You sprint toward the goblin with incredible speed! Before it can throw the torch into the well, you tackle it to the ground!

<div class="combatText">
<strong>‚úÖ ATHLETICS SUCCESS!</strong><br>
You saved the village's water supply!
</div>

The goblin writhes beneath you, but a swift punch to its jaw knocks it unconscious.

<em>"Well done!"</em> Elara exclaims. <em>"The village won't go thirsty thanks to you!"</em>

<div class="combatText">
<strong>üèÜ BONUS REWARD:</strong><br>
‚Ä¢ Villagers' gratitude: +50 bonus XP<br>
‚Ä¢ Elara approves: Relationship +2
</div>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 420, y: 300, state: 'victorious'},
                        {id: 'elara', x: 200, y: 280, state: 'healing'},
                        {id: 'thorin', x: 300, y: 300, state: 'celebrating'},
                        {id: 'lyra', x: 230, y: 250, state: 'looting'}
                    ]
                },
                choices: [
                    {
                        id: 'proceed_victory',
                        label: "‚öîÔ∏è Victory is ours!",
                        description: "Celebrate with your companions and speak to the villagers.",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            well_burning: {
                title: "üî• Flames Rise!",
                text: `You lunge for the goblin, but you're a split-second too late! The torch tumbles into the well with a splash, igniting oil that was floating on the surface!

<div class="combatText">
<strong>‚ùå ATHLETICS FAILED!</strong><br>
The village well is compromised!
</div>

Thick black smoke billows from the well. The goblin cackles before you strike it down with your weapon.

<em>"The water supply is tainted,"</em> Elara says grimly. <em>"We'll need to help them find a new source."</em>

<div class="combatText">
<strong>‚ö†Ô∏è CONSEQUENCE:</strong><br>
‚Ä¢ Village morale decreased<br>
‚Ä¢ Additional quest unlocked: "Find Clean Water"<br>
‚Ä¢ Elara is disappointed: Relationship -1
</div>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 420, y: 300},
                        {id: 'elara', x: 200, y: 280, state: 'disappointed'},
                        {id: 'thorin', x: 300, y: 300},
                        {id: 'lyra', x: 230, y: 250}
                    ]
                },
                choices: [
                    {
                        id: 'continue_on',
                        label: "Continue to victory",
                        description: "The battle is won, but at a cost.",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            spell_finish: {
                title: "‚ú® Arcane Annihilation!",
                text: `You raise your hand and channel arcane energy! Three glowing missiles of pure magic materialize around you!

<div class="combatText">
<strong>‚ú® MAGIC MISSILE CAST!</strong><br>
Three darts of magical force strike the goblin with unerring accuracy!
</div>

<strong>Damage rolls:</strong>
‚Ä¢ Missile 1: <span class="diceRoll">d4+1 = 3</span>
‚Ä¢ Missile 2: <span class="diceRoll">d4+1 = 4</span>
‚Ä¢ Missile 3: <span class="diceRoll">d4+1 = 2</span>

Total damage: <span class="successText">9 damage!</span>

The goblin doesn't even have time to scream before the magical energy tears through it!

<strong>Goblin Pyro: -9 HP ‚Üí üíÄ OBLITERATED!</strong>

<em>"Impressive magic!"</em> Thorin nods approvingly.`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'casting'},
                        {id: 'elara', x: 200, y: 280},
                        {id: 'thorin', x: 300, y: 300, state: 'impressed'},
                        {id: 'lyra', x: 230, y: 250}
                    ]
                },
                choices: [
                    {
                        id: 'claim_victory',
                        label: "‚öîÔ∏è The day is won!",
                        description: "Regroup with your party.",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            goblin_captured: {
                title: "üéØ Prisoner Secured!",
                text: `You drop your weapon and leap at the goblin with your bare hands! The creature struggles, but you manage to pin it down and bind its wrists with rope!

<div class="combatText">
<strong>‚úÖ ATHLETICS SUCCESS!</strong><br>
Goblin captured alive!
</div>

The goblin spits and curses in its guttural language.

<em>"Good thinking,"</em> Lyra says, crouching beside the prisoner. <em>"Let's see what it knows..."</em>

After some *persuasion*, the goblin reveals valuable information:
‚Ä¢ A goblin warband is gathering in the northern ruins
‚Ä¢ They're being led by a mysterious cloaked figure
‚Ä¢ More raids are planned for tomorrow

<div class="combatText">
<strong>üèÜ INTERROGATION SUCCESS:</strong><br>
‚Ä¢ Intelligence gained: +25 bonus XP<br>
‚Ä¢ New quest unlocked: "The Warband Leader"<br>
‚Ä¢ Lyra approves: Relationship +2
</div>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300},
                        {id: 'elara', x: 200, y: 280},
                        {id: 'thorin', x: 300, y: 300},
                        {id: 'lyra', x: 380, y: 300, state: 'interrogating'}
                    ],
                    npcs: [{id: 'goblin_prisoner', x: 420, y: 310, name: 'Bound Goblin'}]
                },
                choices: [
                    {
                        id: 'proceed_after_interrogation',
                        label: "Continue to the aftermath",
                        description: "Secure the prisoner and speak with the villagers.",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            goblins_flee: {
                title: "üò® Goblins Scatter!",
                text: `You step forward, your weapon raised high, and unleash a terrifying battle cry that echoes through the square!

<div class="combatText">
<strong>üò† INTIMIDATION SUCCESS!</strong><br>
The goblins are frightened!
</div>

The goblins' eyes widen in terror. <em>"R-run! These ones too strong!"</em>

They drop their weapons and flee into the forest, stumbling over each other in their panic!

<em>"Well,"</em> Thorin says, slightly disappointed. <em>"That works too, I suppose."</em>

<div class="combatText">
<strong>‚úÖ COMBAT AVOIDED!</strong><br>
‚Ä¢ No damage taken<br>
‚Ä¢ Village saved<br>
‚Ä¢ Peaceful resolution: +100 XP<br>
‚Ä¢ Thorin is slightly disappointed: Relationship -1<br>
‚Ä¢ Elara is pleased: Relationship +1
</div>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'intimidating'},
                        {id: 'elara', x: 200, y: 280, state: 'pleased'},
                        {id: 'thorin', x: 300, y: 300, state: 'disappointed'},
                        {id: 'lyra', x: 230, y: 250}
                    ]
                },
                choices: [
                    {
                        id: 'victory_peaceful',
                        label: "Speak with the villagers",
                        description: "The threat is gone without bloodshed.",
                        nextScene: 'combat_victory'
                    }
                ]
            },

            combat_victory: {
                title: "üéâ Victory!",
                text: `The goblin threat has been neutralized! The village square falls silent except for the crackle of flames and the grateful sobs of surviving villagers.

<div style="text-align: center; font-size: 2em; margin: 20px 0;">
<span class="successText">‚öîÔ∏è VICTORY! ‚öîÔ∏è</span>
</div>

<div class="combatText">
<strong>üèÜ Rewards:</strong><br>
‚Ä¢ Experience Gained: <span class="successText">+150 XP</span><br>
‚Ä¢ Gold Found: <span class="diceRoll">15 gold pieces</span><br>
‚Ä¢ Loot Found: 3√ó Health Potions, Rusty Shortsword, Goblin Ears (quest item)
</div>

An elderly man in simple robes approaches, his weathered face streaked with soot and tears of relief.

<em>"Thank you, brave travelers. I am <strong>Elder Aldric</strong>. These goblins have been raiding us for weeks, but this was their boldest attack yet. They came from the forest to the north... from an old ruin that was once a temple. Something dark stirs there."</em>

He gestures toward the damaged inn. <em>"Please, rest and recover. We'll tend to your wounds and provide what provisions we can. When you're ready... we desperately need you to investigate that ruin. Our village guard is no match for whatever lurks there."</em>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'victorious'},
                        {id: 'elara', x: 200, y: 280, state: 'healing'},
                        {id: 'thorin', x: 300, y: 300, state: 'celebrating'},
                        {id: 'lyra', x: 230, y: 250, state: 'looting'}
                    ],
                    npcs: [{id: 'elder', x: 350, y: 300, name: 'Elder Aldric'}]
                },
                choices: [
                    {
                        id: 'rest_at_inn',
                        label: "üè® Rest at the inn",
                        description: "Recover your strength and heal wounds. (Restores all HP)",
                        nextScene: 'inn_rest'
                    },
                    {
                        id: 'immediate_pursuit',
                        label: "‚ö° Pursue the goblins immediately",
                        description: "Strike while their forces are weakened! (Continue with current HP)",
                        nextScene: 'forest_path'
                    },
                    {
                        id: 'question_elder',
                        label: "üí¨ Ask the Elder more questions",
                        description: "Learn what you can about the temple ruins before proceeding.",
                        nextScene: 'elder_dialogue'
                    },
                    {
                        id: 'search_village',
                        label: "üîç Search the village for supplies",
                        description: "Look for additional items and information.",
                        nextScene: 'village_search'
                    }
                ]
            },

            // CONSENSUS FIX: Added remaining missing scenes
            inn_rest: {
                title: "üè® Rest and Recovery",
                text: `The village inn, though damaged, provides warm beds and hot food. The innkeeper, grateful for your help, refuses payment.

<div class="combatText">
<strong>‚≠ê LONG REST COMPLETED!</strong><br>
‚Ä¢ All HP restored to maximum<br>
‚Ä¢ All spell slots recovered<br>
‚Ä¢ Status effects removed<br>
‚Ä¢ Party morale high!
</div>

You wake refreshed at dawn, ready to face the temple ruins.

<em>"Let's finish this,"</em> Thorin says, strapping on his armor. <em>"Those goblins won't raid this village again."</em>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'rested'},
                        {id: 'elara', x: 200, y: 280, state: 'rested'},
                        {id: 'thorin', x: 300, y: 300, state: 'rested'},
                        {id: 'lyra', x: 230, y: 250, state: 'rested'}
                    ]
                },
                choices: [
                    {
                        id: 'depart_north',
                        label: "üå≤ Head to the temple ruins",
                        description: "Journey north into the dark forest.",
                        nextScene: 'forest_path'
                    }
                ]
            },

            elder_dialogue: {
                title: "üí¨ Elder's Counsel",
                text: `Elder Aldric gestures for you to sit by the fountain.

<em>"The temple was abandoned decades ago when the priests fled something... evil. Recent tremors have awakened it. Travelers speak of green flames and chanting from within."</em>

He hands you a worn map. <em>"This shows the temple entrance. Beware the crypt beneath - many adventurers have entered, none returned."</em>

<div class="combatText">
<strong>üìú INFORMATION GAINED:</strong><br>
‚Ä¢ Temple map acquired<br>
‚Ä¢ Knowledge of the crypt<br>
‚Ä¢ Warning about the danger level
</div>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300},
                        {id: 'elara', x: 200, y: 280},
                        {id: 'thorin', x: 300, y: 300},
                        {id: 'lyra', x: 230, y: 250}
                    ],
                    npcs: [{id: 'elder', x: 350, y: 300, name: 'Elder Aldric'}]
                },
                choices: [
                    {
                        id: 'thank_elder',
                        label: "Thank the Elder and prepare",
                        description: "Use this information to plan your approach.",
                        nextScene: 'inn_rest'
                    }
                ]
            },

            village_search: {
                title: "üîç Searching the Village",
                text: `You spend time exploring the village, checking damaged buildings and speaking with survivors.

<div class="combatText">
<strong>üîç SEARCH RESULTS:</strong><br>
Found items:<br>
‚Ä¢ 2√ó Greater Health Potions<br>
‚Ä¢ Ring of Protection (+1 AC)<br>
‚Ä¢ 50 gold pieces (donated by grateful villagers)<br>
‚Ä¢ Scroll of Fireball
</div>

One elderly woman approaches: <em>"My son went to the temple two days ago. If you find him... please."</em>

<div class="combatText">
<strong>üìú QUEST ADDED:</strong><br>
"Missing Son" - Search the temple for survivors
</div>`,
                sceneData: {
                    environment: 'village_square',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300, state: 'searching'},
                        {id: 'elara', x: 200, y: 280},
                        {id: 'thorin', x: 300, y: 300},
                        {id: 'lyra', x: 230, y: 250, state: 'searching'}
                    ]
                },
                choices: [
                    {
                        id: 'finish_search',
                        label: "Prepare to depart",
                        description: "You've gathered what you need.",
                        nextScene: 'inn_rest'
                    }
                ]
            },

            forest_path: {
                title: "üå≤ The Dark Forest",
                text: `The path north leads into an ancient forest. Gnarled trees block out the sun, creating an oppressive darkness even at midday.

<em>"Stay close,"</em> Lyra warns, hand on her bow. <em>"Something's watching us."</em>

In the distance, you see the crumbling stone temple rising above the trees, green light flickering from its windows.

<div class="combatText">
<strong>‚ö†Ô∏è APPROACHING DANGER!</strong><br>
The temple awaits... but this is where this demo ends.
</div>

<div class="levelUpNotif">
<strong>üéâ DEMO COMPLETE! üéâ</strong><br>
Thank you for playing Baldur's Gate Chronicles Enhanced Edition!<br>
<br>
Your adventure continues in the full version...<br>
<em>(Export your save to preserve your progress!)</em>
</div>`,
                sceneData: {
                    environment: 'dark_forest',
                    partyPositions: [
                        {id: 'player', x: 250, y: 300},
                        {id: 'elara', x: 200, y: 280},
                        {id: 'thorin', x: 300, y: 300},
                        {id: 'lyra', x: 230, y: 250, state: 'alert'}
                    ]
                },
                choices: [
                    {
                        id: 'return_menu',
                        label: "üè† Return to Main Menu",
                        description: "Export your save and return to the menu.",
                        nextScene: 'intro'
                    }
                ]
            }
        };

        // Character templates with CONSENSUS enhancements
        const CHARACTER_TEMPLATES = {
            player: {
                name: 'Hero',
                class: 'Fighter',
                level: 1,
                maxHp: 12,
                currentHp: 12,
                ac: 16,
                initiative: 2,
                str: 16,
                dex: 14,
                con: 14,
                int: 10,
                wis: 12,
                cha: 10
            },
            elara: {
                name: 'Elara',
                class: 'Cleric',
                level: 1,
                maxHp: 10,
                currentHp: 10,
                ac: 14,
                initiative: 1,
                str: 10,
                dex: 12,
                con: 14,
                int: 13,
                wis: 16,
                cha: 14
            },
            thorin: {
                name: 'Thorin',
                class: 'Fighter',
                level: 1,
                maxHp: 14,
                currentHp: 14,
                ac: 18,
                initiative: 0,
                str: 17,
                dex: 10,
                con: 16,
                int: 8,
                wis: 11,
                cha: 9
            },
            lyra: {
                name: 'Lyra',
                class: 'Rogue',
                level: 1,
                maxHp: 8,
                currentHp: 8,
                ac: 15,
                initiative: 4,
                str: 8,
                dex: 18,
                con: 12,
                int: 14,
                wis: 13,
                cha: 12
            }
        };

        // CONSENSUS: Difficulty scaling configuration
        const DIFFICULTY_MODIFIERS = {
            easy: {
                enemyHpMultiplier: 0.75,
                enemyAcBonus: -2,
                enemyDamageMultiplier: 0.8,
                xpMultiplier: 0.8
            },
            normal: {
                enemyHpMultiplier: 1.0,
                enemyAcBonus: 0,
                enemyDamageMultiplier: 1.0,
                xpMultiplier: 1.0
            },
            hard: {
                enemyHpMultiplier: 1.5,
                enemyAcBonus: 2,
                enemyDamageMultiplier: 1.3,
                xpMultiplier: 1.5
            }
        };

        function rollDice(notation) {
            const match = notation.match(/(\d+)d(\d+)(?:([+-])(\d+))?/);
            if (!match) return parseInt(notation) || 0;

            const [, numDice, diceSize, operator, modifier] = match;
            let total = 0;
            let rolls = [];

            for (let i = 0; i < parseInt(numDice); i++) {
                const roll = Math.floor(Math.random() * parseInt(diceSize)) + 1;
                rolls.push(roll);
                total += roll;
            }

            if (operator && modifier) {
                total += operator === '+' ? parseInt(modifier) : -parseInt(modifier);
            }

            return {total, rolls, notation};
        }

        function rollD20(advantage = false, disadvantage = false) {
            const roll1 = Math.floor(Math.random() * 20) + 1;
            if (!advantage && !disadvantage) return roll1;

            const roll2 = Math.floor(Math.random() * 20) + 1;
            return advantage ? Math.max(roll1, roll2) : Math.min(roll1, roll2);
        }

        // CONSENSUS: XP and leveling system
        function awardXP(amount) {
            const modifier = DIFFICULTY_MODIFIERS[gameState.settings.difficulty];
            const adjustedXP = Math.floor(amount * modifier.xpMultiplier);

            gameState.xp += adjustedXP;

            // Check for level up
            while (gameState.xp >= gameState.xpToNextLevel) {
                levelUp();
            }

            return adjustedXP;
        }

        function levelUp() {
            gameState.level++;
            gameState.xp -= gameState.xpToNextLevel;
            gameState.xpToNextLevel = Math.floor(gameState.xpToNextLevel * 1.5);

            // Show level up notification
            const narrativeBox = getElement('narrativeBox');
            narrativeBox.innerHTML += `
                <div class="levelUpNotif">
                    <strong>üéâ LEVEL UP! üéâ</strong><br>
                    You are now Level ${gameState.level}!<br>
                    <em>Your adventures grow more legendary...</em>
                </div>
            `;

            // Update character levels
            gameState.characters.forEach(char => {
                char.level = gameState.level;
                char.maxHp += Math.floor(Math.random() * 6) + 3;
                char.currentHp = char.maxHp;
            });
        }

        class Renderer2D {
            constructor(canvas, ctx) {
                this.canvas = canvas;
                this.ctx = ctx;
            }

            render(sceneData) {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.drawBackground(sceneData.environment);

                if (sceneData.partyPositions) {
                    sceneData.partyPositions.forEach(char => this.drawCharacter(char));
                }

                if (sceneData.enemies) {
                    sceneData.enemies.forEach(enemy => this.drawEnemy(enemy));
                }

                if (sceneData.npcs) {
                    sceneData.npcs.forEach(npc => this.drawNPC(npc));
                }
            }

            drawBackground(env) {
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;

                const backgrounds = {
                    'road_forest': ['#5a7d4e', '#2d3e25'],
                    'village_square': ['#8b7355', '#4a3820'],
                    'dark_forest': ['#2d3e25', '#1a1f15'],
                    'ruins': ['#3a3a3a', '#1a1a1a']
                };

                const colors = backgrounds[env] || backgrounds['road_forest'];
                const grad = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w/2);
                grad.addColorStop(0, colors[0]);
                grad.addColorStop(1, colors[1]);
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, w, h);

                // Subtle grid
                ctx.strokeStyle = 'rgba(244, 208, 63, 0.08)';
                ctx.lineWidth = 1;
                const gridSize = 40;
                for (let x = 0; x < w; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, h);
                    ctx.stroke();
                }
                for (let y = 0; y < h; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                    ctx.stroke();
                }
            }

            drawCharacter(char) {
                const ctx = this.ctx;
                const {x, y, id} = char;

                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(x, y + 35, 20, 8, 0, 0, Math.PI * 2);
                ctx.fill();

                const grad = ctx.createRadialGradient(x, y, 5, x, y, 25);
                const colors = {
                    player: ['#4682b4', '#1e3a5f'],
                    elara: ['#f4d03f', '#c5a747'],
                    thorin: ['#8b4513', '#5a2d0c'],
                    lyra: ['#9370db', '#5a3a7a']
                };

                const color = colors[id] || ['#666', '#333'];
                grad.addColorStop(0, color[0]);
                grad.addColorStop(1, color[1]);

                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'rgba(244, 208, 63, 0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();

                const charData = gameState.characters.find(c => c === CHARACTER_TEMPLATES[id]);
                if (charData) {
                    ctx.fillStyle = '#f4e4c1';
                    ctx.font = 'bold 14px Cinzel';
                    ctx.textAlign = 'center';
                    ctx.fillText(charData.name, x, y - 35);
                }
            }

            drawEnemy(enemy) {
                const ctx = this.ctx;
                const {x, y, type, hp, maxHp} = enemy;

                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(x, y + 25, 15, 6, 0, 0, Math.PI * 2);
                ctx.fill();

                const grad = ctx.createRadialGradient(x, y, 5, x, y, 20);
                grad.addColorStop(0, '#c41e3a');
                grad.addColorStop(1, '#7a1225');

                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.moveTo(x, y - 20);
                ctx.lineTo(x - 18, y + 15);
                ctx.lineTo(x + 18, y + 15);
                ctx.closePath();
                ctx.fill();

                ctx.strokeStyle = 'rgba(239, 68, 68, 0.9)';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(x - 6, y - 5, 3, 0, Math.PI * 2);
                ctx.arc(x + 6, y - 5, 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 12px Cinzel';
                ctx.textAlign = 'center';
                ctx.fillText(type, x, y - 30);
            }

            drawNPC(npc) {
                const ctx = this.ctx;
                const {x, y} = npc;

                ctx.fillStyle = '#c0c0c0';
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#f4d03f';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        class GameEngine {
            constructor() {
                this.canvas = getElement('renderCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.renderer2D = new Renderer2D(this.canvas, this.ctx);

                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                this.loadGameState();
                this.initKeyboardShortcuts();
            }

            resizeCanvas() {
                const visualSection = getElement('visualSection');
                this.canvas.width = visualSection.clientWidth;
                this.canvas.height = visualSection.clientHeight;
                this.render();
            }

            loadGameState() {
                const saved = localStorage.getItem(APP_NAME);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        Object.assign(gameState, data);
                    } catch (e) {
                        console.error('Failed to load save:', e);
                    }
                }
            }

            saveGameState() {
                localStorage.setItem(APP_NAME, JSON.stringify(gameState));
            }

            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '4') {
                        const choices = document.querySelectorAll('.choice');
                        const index = parseInt(e.key) - 1;
                        if (choices[index]) {
                            choices[index].click();
                        }
                    }
                    if (e.key === 'Escape') {
                        const tutorial = getElement('tutorialOverlay');
                        if (tutorial && tutorial.style.display !== 'none') {
                            this.skipTutorial();
                        }
                    }
                });
            }

            newGame() {
                getElement('mainMenu').style.display = 'none';
                getElement('tutorialOverlay').style.display = 'flex';
            }

            startTutorial() {
                gameState.tutorial = true;
                this.initializeGame();
                getElement('tutorialOverlay').style.display = 'none';
            }

            skipTutorial() {
                gameState.tutorial = false;
                this.initializeGame();
                getElement('tutorialOverlay').style.display = 'none';
            }

            initializeGame() {
                gameState = {
                    currentScene: 'intro',
                    characters: [
                        {...CHARACTER_TEMPLATES.player},
                        {...CHARACTER_TEMPLATES.elara},
                        {...CHARACTER_TEMPLATES.thorin},
                        {...CHARACTER_TEMPLATES.lyra}
                    ],
                    choices: {},
                    inventory: ['health_potion', 'health_potion', 'health_potion'],
                    viewMode: '2d',
                    tutorial: gameState.tutorial,
                    xp: 0,
                    level: 1,
                    xpToNextLevel: 300,
                    relationships: {
                        elara: 0,
                        thorin: 0,
                        lyra: 0
                    },
                    combat: {
                        active: false,
                        round: 0,
                        initiative: [],
                        currentTurn: 0,
                        statusEffects: new Map()
                    },
                    settings: gameState.settings
                };

                this.showScene(gameState.currentScene);
                this.updateCharacterPanel();
                this.saveGameState();
            }

            continueGame() {
                if (gameState.currentScene && gameState.characters.length > 0) {
                    getElement('mainMenu').style.display = 'none';
                    this.showScene(gameState.currentScene);
                    this.updateCharacterPanel();
                } else {
                    alert('No saved game found! Starting new adventure...');
                    this.newGame();
                }
            }

            showSettings() {
                const currentDifficulty = gameState.settings.difficulty;
                const newDifficulty = prompt(
                    `‚öôÔ∏è SETTINGS\n\nCurrent Difficulty: ${currentDifficulty}\n\nChoose difficulty:\n‚Ä¢ easy\n‚Ä¢ normal\n‚Ä¢ hard`,
                    currentDifficulty
                );

                if (newDifficulty && ['easy', 'normal', 'hard'].includes(newDifficulty.toLowerCase())) {
                    gameState.settings.difficulty = newDifficulty.toLowerCase();
                    this.saveGameState();
                    alert(`Difficulty set to: ${gameState.settings.difficulty}`);
                }
            }

            showScene(sceneId) {
                const scene = SCENES[sceneId];
                if (!scene) {
                    console.error('Scene not found:', sceneId);
                    return;
                }

                gameState.currentScene = sceneId;

                const narrativeBox = getElement('narrativeBox');
                narrativeBox.innerHTML = `
                    <div class="narrativeTitle">${scene.title}</div>
                    <div class="narrativeText">${scene.text}</div>
                `;

                const choiceBox = getElement('choiceBox');
                choiceBox.innerHTML = '';

                scene.choices.forEach((choice, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'choice';
                    btn.setAttribute('tabindex', '0');
                    btn.setAttribute('role', 'button');
                    btn.innerHTML = `
                        <span class="choiceLabel">[${index + 1}] ${choice.label}</span>
                        <span class="choiceDescription">${choice.description}</span>
                        ${choice.skill ? `<span class="choiceSkill">${choice.skill} DC ${choice.dc}</span>` : ''}
                    `;
                    btn.onclick = () => this.handleChoice(choice);
                    choiceBox.appendChild(btn);
                });

                this.render();
                this.updateXPBar();
                narrativeBox.scrollTop = 0;
                this.saveGameState();
            }

            handleChoice(choice) {
                gameState.choices[gameState.currentScene] = choice.id;

                if (choice.skill) {
                    const roll = rollD20();
                    const modifier = this.getSkillModifier(choice.skill);
                    const total = roll + modifier;

                    const result = total >= choice.dc ? 'success' : 'failure';
                    const nextScene = choice[result];

                    const narrativeBox = getElement('narrativeBox');
                    narrativeBox.innerHTML += `
                        <div class="narrativeText" style="margin-top: 20px;">
                            <strong>üé≤ ${choice.skill} Check:</strong><br>
                            <span class="diceRoll">d20(${roll}) + ${modifier} = ${total}</span> vs DC ${choice.dc}
                            ${result === 'success' ?
                                '<br><span class="successText">‚úì SUCCESS!</span>' :
                                '<br><span class="failText">‚úó FAILURE!</span>'}
                        </div>
                    `;

                    // CONSENSUS: Award XP for skill checks
                    if (result === 'success') {
                        const xpGained = awardXP(25);
                        narrativeBox.innerHTML += `
                            <div class="narrativeText">
                                <span class="successText">+${xpGained} XP</span>
                            </div>
                        `;
                    }

                    setTimeout(() => this.showScene(nextScene), 1500);
                } else if (choice.nextScene) {
                    // Check for combat victory and award XP
                    if (choice.nextScene === 'combat_victory' || gameState.currentScene === 'combat_round_1') {
                        const xpGained = awardXP(150);
                        const narrativeBox = getElement('narrativeBox');
                        narrativeBox.innerHTML += `
                            <div class="narrativeText">
                                <span class="successText">+${xpGained} XP gained!</span>
                            </div>
                        `;
                    }

                    this.showScene(choice.nextScene);
                }
            }

            getSkillModifier(skill) {
                return 3;
            }

            toggleViewMode() {
                gameState.viewMode = gameState.viewMode === '2d' ? '3d' : '2d';
                getElement('modeToggle').textContent = gameState.viewMode === '2d' ? '2D View' : '3D View';
                this.render();
                this.saveGameState();
            }

            render() {
                const scene = SCENES[gameState.currentScene];
                if (!scene || !scene.sceneData) return;

                if (gameState.viewMode === '2d') {
                    this.renderer2D.render(scene.sceneData);
                }
            }

            // CONSENSUS: XP Bar update
            updateXPBar() {
                const panel = getElement('charPanel');
                const existingXPBar = panel.querySelector('.xpBar');
                if (existingXPBar) {
                    existingXPBar.remove();
                }

                const xpPercent = (gameState.xp / gameState.xpToNextLevel) * 100;
                const xpBar = document.createElement('div');
                xpBar.className = 'xpBar';
                xpBar.innerHTML = `
                    <div class="xpFill" style="width: ${xpPercent}%"></div>
                    <div class="xpText">Level ${gameState.level} - ${gameState.xp}/${gameState.xpToNextLevel} XP</div>
                `;

                const firstChild = panel.firstElementChild;
                if (firstChild && firstChild.nextSibling) {
                    panel.insertBefore(xpBar, firstChild.nextSibling);
                } else {
                    panel.appendChild(xpBar);
                }
            }

            updateCharacterPanel() {
                const panel = getElement('charPanel');
                panel.innerHTML = '<div style="font-family: Cinzel; color: var(--gold); margin-bottom: 15px; font-size: 1.1em;">‚öîÔ∏è Party</div>';

                gameState.characters.forEach(char => {
                    const hpPercent = (char.currentHp / char.maxHp) * 100;
                    const card = document.createElement('div');
                    card.className = 'charCard';
                    card.setAttribute('role', 'article');
                    card.setAttribute('aria-label', `${char.name} character card`);
                    card.innerHTML = `
                        <div class="charName">${char.name}</div>
                        <div class="charClass">Level ${char.level} ${char.class}</div>
                        <div class="healthBar" role="progressbar" aria-valuenow="${char.currentHp}" aria-valuemin="0" aria-valuemax="${char.maxHp}">
                            <div class="healthFill" style="width: ${hpPercent}%"></div>
                            <div class="healthText">${char.currentHp}/${char.maxHp} HP</div>
                        </div>
                        <div class="charStats">
                            <div class="statBox">
                                <div class="statLabel">STR</div>
                                <div class="statValue">${char.str || 10}</div>
                            </div>
                            <div class="statBox">
                                <div class="statLabel">DEX</div>
                                <div class="statValue">${char.dex || 10}</div>
                            </div>
                            <div class="statBox">
                                <div class="statLabel">CON</div>
                                <div class="statValue">${char.con || 10}</div>
                            </div>
                        </div>
                    `;
                    panel.appendChild(card);
                });

                this.updateXPBar();
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(gameState, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `baldurs-gate-save-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.assign(gameState, data);
                    game.showScene(gameState.currentScene);
                    game.updateCharacterPanel();
                    game.saveGameState();
                    alert('‚úì Save loaded successfully!');
                } catch (error) {
                    alert('‚úó Invalid save file!');
                }
            };
            reader.readAsText(file);
        }

        let game;
        window.addEventListener('DOMContentLoaded', () => {
            game = new GameEngine();
        });
    </script>
</body>
</html>
