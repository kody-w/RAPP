<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D: Shadows of Ravenloft - ENHANCED Edition</title>
    <meta name="description" content="Recursively improved by 8 AI strategy agents">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Cinzel', 'Georgia', serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
            color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #renderCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        /* =====UI IMPROVEMENTS (Consensus: UX + Visual + Technical)===== */
        #uiOverlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        #uiOverlay > * { pointer-events: auto; }

        /* Enhanced Tooltip System (Consensus Item) */
        .tooltip {
            position: absolute;
            background: rgba(10, 10, 20, 0.98);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            z-index: 9999;
            display: none;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip.active { display: block; }

        .tooltip-title {
            color: #d4af37;
            font-size: 1.2em;
            margin-bottom: 8px;
            border-bottom: 1px solid #d4af37;
            padding-bottom: 5px;
        }

        .tooltip-stat {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .tooltip-description {
            color: #aaa;
            font-size: 0.85em;
            margin-top: 10px;
            font-style: italic;
        }

        /* Status Effects UI (Consensus: Combat + Balance + Visual) */
        .status-effects {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .status-effect {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            border: 2px solid;
            position: relative;
            animation: statusPulse 2s infinite;
        }

        @keyframes statusPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .status-stunned { background: #4444ff; border-color: #6666ff; }
        .status-poisoned { background: #44ff44; border-color: #66ff66; }
        .status-burning { background: #ff4444; border-color: #ff6666; }
        .status-frozen { background: #44ffff; border-color: #66ffff; }
        .status-blessed { background: #ffdd44; border-color: #ffee66; }
        .status-cursed { background: #8844ff; border-color: #9966ff; }

        .status-duration {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #000;
            color: #fff;
            font-size: 0.7em;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Character Creation */
        #characterCreation {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 0.98);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #d4af37;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.7);
            max-width: 700px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
        }

        #characterCreation h1 {
            color: #d4af37;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.8em;
            text-shadow: 0 0 15px rgba(212, 175, 55, 1);
            animation: titleGlow 3s infinite;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 15px rgba(212, 175, 55, 0.8); }
            50% { text-shadow: 0 0 25px rgba(212, 175, 55, 1); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #d4af37;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid #d4af37;
            border-radius: 10px;
            color: #f0f0f0;
            font-size: 1.1em;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #ffee66;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
            outline: none;
        }

        .race-grid, .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .race-card, .class-card {
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .race-card:hover, .class-card:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
        }

        .race-card.selected, .class-card.selected {
            background: rgba(212, 175, 55, 0.25);
            border-color: #ffee66;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
            border-width: 3px;
        }

        .race-icon, .class-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.5));
        }

        .btn {
            background: linear-gradient(135deg, #d4af37 0%, #ffee66 50%, #d4af37 100%);
            background-size: 200% 100%;
            color: #1a1a2e;
            border: none;
            padding: 18px 50px;
            font-size: 1.3em;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s;
            margin-top: 25px;
            width: 100%;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .btn:hover {
            background-position: 100% 0;
            transform: scale(1.05);
            box-shadow: 0 0 35px rgba(212, 175, 55, 0.9);
        }

        /* Enhanced HUD with Progressive Disclosure */
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .hud-panel {
            background: rgba(15, 15, 30, 0.95);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .hud-panel:hover {
            border-color: #ffee66;
            box-shadow: 0 0 35px rgba(212, 175, 55, 0.4);
        }

        #characterInfo {
            min-width: 280px;
        }

        .character-name {
            color: #d4af37;
            font-size: 1.6em;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
        }

        .character-class {
            color: #aaa;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .stat-bar {
            margin-bottom: 12px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .bar-container {
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #666;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.8s ease, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        /* Animated bar shimmer effect */
        .bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: barShimmer 2s infinite;
        }

        @keyframes barShimmer {
            to { left: 100%; }
        }

        .hp-bar {
            background: linear-gradient(90deg, #ff4444, #ff6666, #cc0000);
        }

        .hp-bar.low {
            background: linear-gradient(90deg, #ff0000, #cc0000);
            animation: barPulse 1s infinite;
        }

        @keyframes barPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }

        .xp-bar {
            background: linear-gradient(90deg, #44ff44, #66ff66, #00cc00);
        }

        .mana-bar {
            background: linear-gradient(90deg, #4444ff, #6666ff, #0000cc);
        }

        /* Ability Scores Grid */
        .ability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .ability-score {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s;
        }

        .ability-score:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }

        .ability-name {
            color: #aaa;
            font-size: 0.85em;
        }

        .ability-value {
            color: #d4af37;
            font-weight: bold;
            font-size: 1.3em;
            margin-top: 5px;
        }

        .ability-modifier {
            color: #66ff66;
            font-size: 0.9em;
        }

        /* Quest Panel Enhancement */
        #questPanel {
            min-width: 250px;
        }

        .quest-title {
            color: #d4af37;
            font-size: 1.2em;
            margin-bottom: 12px;
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
        }

        .quest-item {
            background: rgba(255, 255, 255, 0.06);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.95em;
            border-left: 4px solid #d4af37;
            transition: all 0.3s;
        }

        .quest-item:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateX(5px);
        }

        .quest-progress {
            margin-top: 8px;
            height: 6px;
            background: rgba(0,0,0,0.5);
            border-radius: 3px;
            overflow: hidden;
        }

        .quest-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #ffee66);
            transition: width 0.5s;
        }

        /* Enhanced Action Bar with Tooltips */
        #actionBar {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 18px;
            padding: 15px;
            background: rgba(15, 15, 30, 0.95);
            border-radius: 20px;
            border: 2px solid #d4af37;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }

        .action-btn {
            width: 80px;
            height: 80px;
            background: rgba(30, 30, 50, 0.9);
            border: 2px solid #d4af37;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.8em;
            position: relative;
        }

        .action-btn:hover {
            background: rgba(212, 175, 55, 0.25);
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
            border-width: 3px;
        }

        .action-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .action-btn.available {
            animation: actionHighlight 2s infinite;
        }

        @keyframes actionHighlight {
            0%, 100% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.6); }
            50% { box-shadow: 0 0 30px rgba(212, 175, 55, 1); }
        }

        .action-label {
            font-size: 0.45em;
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-cooldown {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5em;
            color: #ff4444;
        }

        /* Enhanced Dialog System */
        #dialogBox {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 900px;
            background: rgba(15, 15, 30, 0.98);
            border: 3px solid #d4af37;
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
            display: none;
        }

        #dialogBox.active {
            display: block;
            animation: dialogSlideUp 0.4s ease;
        }

        @keyframes dialogSlideUp {
            from {
                transform: translateX(-50%) translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .dialog-speaker {
            color: #d4af37;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .speaker-portrait {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4af37, #aa8c2e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            border: 2px solid #ffee66;
        }

        .dialog-text {
            font-size: 1.15em;
            line-height: 1.8;
            margin-bottom: 25px;
            color: #f0f0f0;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-btn {
            background: rgba(212, 175, 55, 0.15);
            border: 2px solid #d4af37;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            color: #f0f0f0;
            font-size: 1.05em;
            position: relative;
            padding-left: 45px;
        }

        .choice-btn::before {
            content: '‚ñ∂';
            position: absolute;
            left: 18px;
            color: #d4af37;
            transition: all 0.3s;
        }

        .choice-btn:hover {
            background: rgba(212, 175, 55, 0.35);
            transform: translateX(15px);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.5);
        }

        .choice-btn:hover::before {
            left: 22px;
        }

        .choice-skill {
            color: #66ff66;
            font-size: 0.85em;
            font-style: italic;
        }

        .choice-result {
            color: #aaa;
            font-size: 0.85em;
        }

        /* Enhanced Combat UI */
        #combatUI {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 92%;
            max-width: 1100px;
            background: rgba(15, 15, 30, 0.98);
            border: 4px solid #cc0000;
            border-radius: 25px;
            padding: 35px;
            display: none;
            box-shadow: 0 0 60px rgba(204, 0, 0, 0.8);
        }

        #combatUI.active {
            display: block;
            animation: combatZoomIn 0.4s ease;
        }

        @keyframes combatZoomIn {
            from {
                transform: translate(-50%, -50%) scale(0.85);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .combat-header {
            text-align: center;
            color: #ff4444;
            font-size: 2.3em;
            margin-bottom: 25px;
            text-shadow: 0 0 15px rgba(255, 68, 68, 1);
            animation: combatTitlePulse 2s infinite;
        }

        @keyframes combatTitlePulse {
            0%, 100% { text-shadow: 0 0 15px rgba(255, 68, 68, 0.8); }
            50% { text-shadow: 0 0 30px rgba(255, 68, 68, 1); }
        }

        /* Initiative Timeline (Consensus: UX improvement) */
        .initiative-timeline {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            justify-content: center;
        }

        .initiative-portrait {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            border: 3px solid;
            position: relative;
            transition: all 0.3s;
        }

        .initiative-portrait.active {
            border-color: #ffee66;
            box-shadow: 0 0 25px #ffee66;
            transform: scale(1.2);
        }

        .initiative-portrait.ally {
            background: rgba(68, 136, 255, 0.3);
            border-color: #4488ff;
        }

        .initiative-portrait.enemy {
            background: rgba(255, 68, 68, 0.3);
            border-color: #ff4444;
        }

        .combatants {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 20px;
        }

        .combatant {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            border: 2px solid rgba(212, 175, 55, 0.4);
            flex: 1;
            transition: all 0.3s;
        }

        .combatant:hover {
            border-color: #d4af37;
            transform: scale(1.05);
        }

        .combatant-name {
            font-size: 1.4em;
            color: #d4af37;
            margin-bottom: 12px;
        }

        .combatant-hp {
            font-size: 1.7em;
            color: #ff4444;
            margin: 12px 0;
            font-weight: bold;
        }

        .combatant-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
            font-size: 0.95em;
        }

        .combat-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .combat-action-btn {
            background: rgba(212, 175, 55, 0.15);
            border: 2px solid #d4af37;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.05em;
            color: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .combat-action-btn:hover:not(.disabled) {
            background: rgba(212, 175, 55, 0.35);
            transform: scale(1.08);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.5);
        }

        .combat-action-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-icon {
            font-size: 1.5em;
        }

        .combat-log {
            margin-top: 20px;
            padding: 18px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            max-height: 180px;
            overflow-y: auto;
            border: 2px solid rgba(212, 175, 55, 0.3);
        }

        .combat-log-entry {
            margin: 6px 0;
            padding: 8px;
            border-left: 4px solid #d4af37;
            padding-left: 12px;
            animation: logEntrySlide 0.3s ease;
        }

        @keyframes logEntrySlide {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .log-hit { border-left-color: #ff4444; color: #ff6666; }
        .log-miss { border-left-color: #aaa; color: #ccc; }
        .log-crit { border-left-color: #ffee66; color: #ffee66; font-weight: bold; }
        .log-heal { border-left-color: #44ff44; color: #66ff66; }

        /* Floating Damage Numbers (Visual feedback enhancement) */
        .floating-number {
            position: absolute;
            font-size: 2em;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
            z-index: 1000;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(1.5);
                opacity: 0;
            }
        }

        .floating-number.damage {
            color: #ff4444;
            text-shadow: 0 0 10px #ff0000;
        }

        .floating-number.heal {
            color: #44ff44;
            text-shadow: 0 0 10px #00ff00;
        }

        .floating-number.crit {
            color: #ffee66;
            text-shadow: 0 0 15px #ffaa00;
            font-size: 2.5em;
        }

        /* Dice Roll Animation Enhancement */
        #diceRoll {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6em;
            color: #d4af37;
            display: none;
            animation: diceRollEnhanced 1.2s ease;
            text-shadow: 0 0 40px rgba(212, 175, 55, 1);
            z-index: 10000;
        }

        @keyframes diceRollEnhanced {
            0% {
                transform: translate(-50%, -50%) rotate(0deg) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) rotate(180deg) scale(1.3);
                opacity: 1;
            }
            40% {
                transform: translate(-50%, -50%) rotate(360deg) scale(1);
            }
            60% {
                transform: translate(-50%, -50%) rotate(540deg) scale(1.2);
            }
            80% {
                transform: translate(-50%, -50%) rotate(720deg) scale(1);
            }
            100% {
                transform: translate(-50%, -50%) rotate(720deg) scale(1.3);
                opacity: 1;
            }
        }

        /* Inventory Enhancement */
        #inventoryPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            max-width: 95%;
            background: rgba(15, 15, 30, 0.98);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 35px;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }

        #inventoryPanel.active {
            display: block;
            animation: panelFadeIn 0.3s ease;
        }

        @keyframes panelFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .inventory-title {
            color: #d4af37;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
        }

        .gold-display {
            font-size: 1.5em;
            color: #ffee66;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 25px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
            transform: scale(1.08);
        }

        .inventory-slot.filled {
            background: rgba(212, 175, 55, 0.12);
            border-color: #d4af37;
        }

        .inventory-slot.filled:hover {
            background: rgba(212, 175, 55, 0.25);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .item-rarity {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .rarity-common { background: #aaa; }
        .rarity-uncommon { background: #44ff44; }
        .rarity-rare { background: #4444ff; }
        .rarity-epic { background: #8844ff; }
        .rarity-legendary { background: #ff8844; }

        /* Companion Panel (New Consensus Feature) */
        #companionPanel {
            position: absolute;
            right: 20px;
            bottom: 140px;
            width: 280px;
            background: rgba(15, 15, 30, 0.95);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 20px;
            display: none;
        }

        #companionPanel.active {
            display: block;
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .companion-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .companion-card {
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .companion-card:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
            transform: translateX(-5px);
        }

        .companion-name {
            color: #d4af37;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .companion-class {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .companion-relationship {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .relationship-hearts {
            color: #ff4444;
            font-size: 1.2em;
        }

        /* Performance Monitor (Technical Enhancement) */
        #performanceMonitor {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #44ff44;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85em;
            display: none;
        }

        #performanceMonitor.active {
            display: block;
        }

        /* Loading Screen Enhancement */
        #loadingScreen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-text {
            font-size: 2.5em;
            color: #d4af37;
            margin-bottom: 40px;
            animation: loadingPulse 2.5s infinite;
            text-shadow: 0 0 20px rgba(212, 175, 55, 1);
        }

        @keyframes loadingPulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.05);
            }
        }

        .loading-bar {
            width: 400px;
            height: 35px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 18px;
            overflow: hidden;
            border: 3px solid #d4af37;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.5);
        }

        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #ffee66, #d4af37);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.3s;
            animation: loadingShimmer 2s infinite;
        }

        @keyframes loadingShimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .loading-tips {
            margin-top: 30px;
            color: #aaa;
            font-size: 1.1em;
            max-width: 500px;
            text-align: center;
            line-height: 1.6;
        }

        .hide { display: none !important; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffee66;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #hud { flex-direction: column; }
            .hud-panel { width: 100%; }
            #actionBar {
                flex-wrap: wrap;
                bottom: 15px;
                gap: 12px;
            }
            .action-btn {
                width: 65px;
                height: 65px;
                font-size: 1.5em;
            }
            #dialogBox {
                width: 95%;
                bottom: 110px;
                padding: 20px;
            }
            .initiative-timeline {
                flex-wrap: wrap;
            }
            .initiative-portrait {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="renderCanvas"></canvas>

        <div id="uiOverlay">
            <!-- Loading Screen -->
            <div id="loadingScreen">
                <h1 class="loading-text">‚öîÔ∏è SHADOWS OF RAVENLOFT ‚öîÔ∏è</h1>
                <div style="color: #aaa; margin-bottom: 20px; font-size: 1.1em;">ENHANCED EDITION</div>
                <div class="loading-bar">
                    <div class="loading-fill" id="loadingFill"></div>
                </div>
                <div class="loading-tips" id="loadingTip">
                    Tip: Positioning matters! Flanking enemies grants advantage on attacks.
                </div>
            </div>

            <!-- Tooltip -->
            <div class="tooltip" id="gameTooltip">
                <div class="tooltip-title"></div>
                <div class="tooltip-content"></div>
            </div>

            <!-- Performance Monitor -->
            <div id="performanceMonitor">
                <div>FPS: <span id="fpsCounter">60</span></div>
                <div>Draw Calls: <span id="drawCalls">0</span></div>
                <div>Particles: <span id="particleCount">0</span></div>
            </div>

            <!-- Character Creation -->
            <div id="characterCreation" class="hide">
                <h1>‚öîÔ∏è Create Your Hero ‚öîÔ∏è</h1>
                <p style="text-align: center; color: #aaa; margin-bottom: 25px;">
                    Recursively improved by 8 AI strategy agents
                </p>

                <div class="form-group">
                    <label>Character Name</label>
                    <input type="text" id="charName" placeholder="Enter your hero's name" value="Thorin Battleborn">
                </div>

                <div class="form-group">
                    <label>Choose Your Race</label>
                    <div class="race-grid">
                        <div class="race-card" data-race="human">
                            <div class="race-icon">üë§</div>
                            <div><strong>Human</strong></div>
                            <small>+1 All Stats</small>
                        </div>
                        <div class="race-card selected" data-race="dwarf">
                            <div class="race-icon">üßî</div>
                            <div><strong>Dwarf</strong></div>
                            <small>+2 CON, Resilient</small>
                        </div>
                        <div class="race-card" data-race="elf">
                            <div class="race-icon">üßù</div>
                            <div><strong>Elf</strong></div>
                            <small>+2 DEX, Darkvision</small>
                        </div>
                        <div class="race-card" data-race="tiefling">
                            <div class="race-icon">üòà</div>
                            <div><strong>Tiefling</strong></div>
                            <small>+2 CHA, +1 INT</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Choose Your Class</label>
                    <div class="class-grid">
                        <div class="class-card selected" data-class="fighter">
                            <div class="class-icon">‚öîÔ∏è</div>
                            <div><strong>Fighter</strong></div>
                            <small>Weapon Master</small>
                        </div>
                        <div class="class-card" data-class="wizard">
                            <div class="class-icon">üßô</div>
                            <div><strong>Wizard</strong></div>
                            <small>Arcane Power</small>
                        </div>
                        <div class="class-card" data-class="rogue">
                            <div class="class-icon">üó°Ô∏è</div>
                            <div><strong>Rogue</strong></div>
                            <small>Sneak Attack</small>
                        </div>
                        <div class="class-card" data-class="cleric">
                            <div class="class-icon">‚õ™</div>
                            <div><strong>Cleric</strong></div>
                            <small>Divine Healer</small>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="game.startGame()">Begin Your Quest</button>
            </div>

            <!-- HUD -->
            <div id="hud" class="hide">
                <div class="hud-panel" id="characterInfo">
                    <div class="character-name" id="charNameDisplay">Hero</div>
                    <div class="character-class" id="charClassDisplay">Level 1 Fighter</div>

                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>‚ù§Ô∏è HP</span>
                            <span id="hpDisplay">12/12</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill hp-bar" id="hpBar" style="width: 100%"></div>
                        </div>
                    </div>

                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>‚ú® XP</span>
                            <span id="xpDisplay">0/300</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill xp-bar" id="xpBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="ability-grid">
                        <div class="ability-score" data-tooltip="Strength affects melee damage and athletic checks">
                            <div class="ability-name">STR</div>
                            <div class="ability-value" id="strDisplay">16</div>
                            <div class="ability-modifier">+3</div>
                        </div>
                        <div class="ability-score" data-tooltip="Dexterity affects AC, ranged attacks, and stealth">
                            <div class="ability-name">DEX</div>
                            <div class="ability-value" id="dexDisplay">12</div>
                            <div class="ability-modifier">+1</div>
                        </div>
                        <div class="ability-score" data-tooltip="Constitution determines hit points and resilience">
                            <div class="ability-name">CON</div>
                            <div class="ability-value" id="conDisplay">14</div>
                            <div class="ability-modifier">+2</div>
                        </div>
                    </div>

                    <div class="status-effects" id="playerStatusEffects"></div>
                </div>

                <div class="hud-panel" id="questPanel">
                    <div class="quest-title">üìú Active Quests</div>
                    <div class="quest-item" id="activeQuest">
                        <div>Explore the Cursed Village</div>
                        <div class="quest-progress">
                            <div class="quest-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div id="actionBar" class="hide">
                <div class="action-btn" onclick="game.openInventory()" data-tooltip="Open Inventory (I)">
                    <div>üéí</div>
                    <div class="action-label">Bag</div>
                </div>
                <div class="action-btn available" onclick="game.interact()" data-tooltip="Interact with NPCs (E)">
                    <div>üí¨</div>
                    <div class="action-label">Talk</div>
                </div>
                <div class="action-btn" onclick="game.search()" data-tooltip="Search for hidden items">
                    <div>üîç</div>
                    <div class="action-label">Search</div>
                </div>
                <div class="action-btn" onclick="game.rest()" data-tooltip="Rest to recover HP (R)">
                    <div>üèïÔ∏è</div>
                    <div class="action-label">Rest</div>
                </div>
                <div class="action-btn" onclick="game.toggleCompanions()" data-tooltip="Manage Companions">
                    <div>üë•</div>
                    <div class="action-label">Party</div>
                </div>
            </div>

            <!-- Dialog Box -->
            <div id="dialogBox">
                <div class="dialog-speaker">
                    <div class="speaker-portrait">üßô</div>
                    <div id="speakerName">Quest Master</div>
                </div>
                <div class="dialog-text" id="dialogText"></div>
                <div class="choices" id="dialogChoices"></div>
            </div>

            <!-- Combat UI -->
            <div id="combatUI">
                <h2 class="combat-header">‚öîÔ∏è COMBAT ‚öîÔ∏è</h2>

                <div class="initiative-timeline" id="initiativeTimeline"></div>

                <div class="combatants">
                    <div class="combatant">
                        <div class="combatant-name" id="playerCombatName">Hero</div>
                        <div class="combatant-hp" id="playerCombatHP">12/12</div>
                        <div class="combatant-stats">
                            <div>AC: <span id="playerCombatAC">15</span></div>
                            <div>Initiative: <span id="playerInitiative">12</span></div>
                        </div>
                        <div class="status-effects" id="playerCombatStatus"></div>
                    </div>
                    <div class="combatant">
                        <div class="combatant-name" id="enemyCombatName">Enemy</div>
                        <div class="combatant-hp" id="enemyCombatHP">10/10</div>
                        <div class="combatant-stats">
                            <div>AC: <span id="enemyCombatAC">13</span></div>
                            <div>Initiative: <span id="enemyInitiative">8</span></div>
                        </div>
                        <div class="status-effects" id="enemyCombatStatus"></div>
                    </div>
                </div>

                <div class="combat-actions">
                    <button class="combat-action-btn" onclick="game.combatAction('attack')" data-tooltip="Basic melee/ranged attack">
                        <span class="action-icon">‚öîÔ∏è</span>
                        <span>Attack</span>
                    </button>
                    <button class="combat-action-btn" onclick="game.combatAction('defend')" data-tooltip="+2 AC until next turn">
                        <span class="action-icon">üõ°Ô∏è</span>
                        <span>Defend</span>
                    </button>
                    <button class="combat-action-btn" onclick="game.combatAction('spell')" data-tooltip="Cast a spell">
                        <span class="action-icon">‚ú®</span>
                        <span>Spell</span>
                    </button>
                    <button class="combat-action-btn" onclick="game.combatAction('item')" data-tooltip="Use an item">
                        <span class="action-icon">üß™</span>
                        <span>Item</span>
                    </button>
                    <button class="combat-action-btn" onclick="game.combatAction('special')" data-tooltip="Class-specific ability">
                        <span class="action-icon">üí•</span>
                        <span>Special</span>
                    </button>
                    <button class="combat-action-btn" onclick="game.combatAction('dodge')" data-tooltip="Attacks against you have disadvantage">
                        <span class="action-icon">üåÄ</span>
                        <span>Dodge</span>
                    </button>
                </div>

                <div class="combat-log" id="combatLog"></div>
            </div>

            <!-- Inventory -->
            <div id="inventoryPanel">
                <div class="inventory-header">
                    <h2 class="inventory-title">üéí Inventory</h2>
                    <div class="gold-display">
                        <span id="goldDisplay">50</span> üí∞
                    </div>
                </div>
                <div class="inventory-grid" id="inventoryGrid"></div>
                <button class="btn" onclick="game.closeInventory()" style="margin-top: 25px;">Close</button>
            </div>

            <!-- Companion Panel -->
            <div id="companionPanel">
                <h3 style="color: #d4af37; margin-bottom: 15px; text-align: center;">üë• Companions</h3>
                <div class="companion-list" id="companionList"></div>
                <button class="btn" onclick="game.toggleCompanions()" style="margin-top: 15px; padding: 10px; font-size: 1em;">Close</button>
            </div>

            <!-- Dice Roll -->
            <div id="diceRoll">üé≤ 20</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ===== ENHANCED D&D GAME ENGINE =====
        // Recursively improved by 8 AI Strategy Agents
        // Implementing: Status Effects, Advanced Combat, Companions,
        // Enhanced UI, Performance Optimization, Better AI

        const STATUS_EFFECTS = {
            STUNNED: { name: 'Stunned', icon: 'üòµ', color: '#4444ff', duration: 2, effect: 'skipTurn' },
            POISONED: { name: 'Poisoned', icon: 'ü§¢', color: '#44ff44', duration: 3, effect: 'damageOverTime', damage: 2 },
            BURNING: { name: 'Burning', icon: 'üî•', color: '#ff4444', duration: 3, effect: 'damageOverTime', damage: 3 },
            FROZEN: { name: 'Frozen', icon: '‚ùÑÔ∏è', color: '#44ffff', duration: 2, effect: 'halfMovement' },
            BLESSED: { name: 'Blessed', icon: '‚ú®', color: '#ffdd44', duration: 3, effect: 'advantage' },
            CURSED: { name: 'Cursed', icon: 'üòà', color: '#8844ff', duration: 3, effect: 'disadvantage' }
        };

        const LOADING_TIPS = [
            "Tip: Positioning matters! Flanking enemies grants advantage on attacks.",
            "Tip: Status effects can turn the tide of battle. Use them wisely!",
            "Tip: Build relationships with companions for combat bonuses.",
            "Tip: Rest frequently to recover HP and spell slots.",
            "Tip: Search thoroughly - hidden treasures await the curious!",
            "Tip: Different damage types are effective against different enemies.",
            "Tip: Save often! The world of Ravenloft is unforgiving.",
            "Tip: Talk to everyone - NPCs have valuable information and quests."
        ];

        class DnDGameEnhanced {
            constructor() {
                this.character = null;
                this.companions = [];
                this.inventory = [];
                this.gold = 50;
                this.combat = null;
                this.statusEffects = [];
                this.gameState = 'loading';

                // 3D Engine
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.player = null;
                this.enemies = [];
                this.particles = [];

                // Performance tracking
                this.fps = 0;
                this.frameCount = 0;
                this.lastFPSUpdate = Date.now();

                // Object pools for performance
                this.particlePool = [];
                this.floatingNumberPool = [];

                this.init();
            }

            init() {
                this.initThreeJS();
                this.initEventListeners();
                this.initTooltips();
                this.loadGame();
            }

            initThreeJS() {
                const canvas = document.getElementById('renderCanvas');
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x0f0f1e, 15, 60);

                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 8, 15);
                this.camera.lookAt(0, 0, 0);

                this.renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                // Enhanced lighting
                const ambientLight = new THREE.AmbientLight(0x2a2a3a, 0.6);
                this.scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
                directionalLight.position.set(8, 15, 8);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);

                const pointLight = new THREE.PointLight(0xd4af37, 1.5, 25);
                pointLight.position.set(0, 6, 0);
                this.scene.add(pointLight);

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });

                this.animate();
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                // FPS Counter
                this.frameCount++;
                const now = Date.now();
                if (now - this.lastFPSUpdate >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFPSUpdate = now;
                    document.getElementById('fpsCounter').textContent = this.fps;
                }

                // Update particles
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.position.y += p.velocity.y;
                    p.position.x += p.velocity.x;
                    p.position.z += p.velocity.z;
                    p.material.opacity -= 0.015;

                    if (p.material.opacity <= 0) {
                        this.scene.remove(p);
                        this.particles.splice(i, 1);
                        this.returnToParticlePool(p);
                    }
                }

                document.getElementById('particleCount').textContent = this.particles.length;

                if (this.player && !this.combat) {
                    this.player.rotation.y += 0.008;
                }

                this.enemies.forEach(enemy => {
                    if (enemy.alive) {
                        enemy.mesh.rotation.y += 0.012;
                        enemy.mesh.position.y = 0.75 + Math.sin(Date.now() * 0.003) * 0.15;
                    }
                });

                this.renderer.render(this.scene, this.camera);
            }

            loadGame() {
                let progress = 0;
                const loadingFill = document.getElementById('loadingFill');
                const loadingTip = document.getElementById('loadingTip');

                loadingTip.textContent = LOADING_TIPS[Math.floor(Math.random() * LOADING_TIPS.length)];

                const interval = setInterval(() => {
                    progress += Math.random() * 25;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        setTimeout(() => {
                            document.getElementById('loadingScreen').classList.add('hide');
                            document.getElementById('characterCreation').classList.remove('hide');
                        }, 600);
                    }
                    loadingFill.style.width = progress + '%';
                }, 250);
            }

            initEventListeners() {
                // Race/Class selection
                document.querySelectorAll('.race-card, .class-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const group = card.classList.contains('race-card') ? '.race-card' : '.class-card';
                        document.querySelectorAll(group).forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'playing') return;
                    switch(e.key.toLowerCase()) {
                        case 'i': this.openInventory(); break;
                        case 'e': this.interact(); break;
                        case 'r': this.rest(); break;
                        case '`': this.togglePerformanceMonitor(); break;
                    }
                });
            }

            initTooltips() {
                document.querySelectorAll('[data-tooltip]').forEach(elem => {
                    elem.addEventListener('mouseenter', (e) => {
                        const tooltip = document.getElementById('gameTooltip');
                        const text = elem.getAttribute('data-tooltip');
                        tooltip.querySelector('.tooltip-title').textContent = elem.textContent.trim();
                        tooltip.querySelector('.tooltip-content').textContent = text;
                        tooltip.classList.add('active');

                        const rect = elem.getBoundingClientRect();
                        tooltip.style.left = rect.left + 'px';
                        tooltip.style.top = (rect.bottom + 10) + 'px';
                    });

                    elem.addEventListener('mouseleave', () => {
                        document.getElementById('gameTooltip').classList.remove('active');
                    });
                });
            }

            startGame() {
                const name = document.getElementById('charName').value || 'Hero';
                const race = document.querySelector('.race-card.selected').dataset.race;
                const charClass = document.querySelector('.class-card.selected').dataset.class;

                this.character = {
                    name, race, class: charClass, level: 1, xp: 0,
                    hp: 12, maxHp: 12, mana: 10, maxMana: 10,
                    str: 16, dex: 12, con: 14, int: 10, wis: 12, cha: 10,
                    ac: 15, statusEffects: []
                };

                this.inventory = ['‚öîÔ∏è Longsword', 'üõ°Ô∏è Shield', 'üß™ Health Potion', 'üçû Rations'];
                this.initializeCompanions();

                document.getElementById('characterCreation').classList.add('hide');
                document.getElementById('hud').classList.remove('hide');
                document.getElementById('actionBar').classList.remove('hide');

                this.updateHUD();
                this.createPlayer();
                this.startCampaign();
                this.gameState = 'playing';
            }

            initializeCompanions() {
                this.companions = [
                    { name: 'Elara', class: 'Cleric', level: 1, relationship: 3, icon: '‚õ™' },
                    { name: 'Shadow', class: 'Rogue', level: 1, relationship: 2, icon: 'üó°Ô∏è' }
                ];
                this.updateCompanionPanel();
            }

            createPlayer() {
                const geometry = new THREE.CapsuleGeometry(0.5, 1.8, 4, 8);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x4488ff,
                    emissive: 0x112244,
                    shininess: 30
                });
                this.player = new THREE.Mesh(geometry, material);
                this.player.position.set(0, 1.2, 0);
                this.player.castShadow = true;
                this.scene.add(this.player);

                // Weapon
                const weaponGeom = new THREE.BoxGeometry(0.1, 1.8, 0.1);
                const weaponMat = new THREE.MeshPhongMaterial({ color: 0xd4af37 });
                const weapon = new THREE.Mesh(weaponGeom, weaponMat);
                weapon.position.set(0.7, 0, 0);
                this.player.add(weapon);
            }

            createEnvironment(type = 'village') {
                // Implementation similar to original but enhanced
                const groundGeom = new THREE.PlaneGeometry(60, 60);
                const groundMat = new THREE.MeshStandardMaterial({
                    color: type === 'village' ? 0x2a4a2a : 0x3a3a3a,
                    roughness: 0.9
                });
                const ground = new THREE.Mesh(groundGeom, groundMat);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                this.scene.add(ground);
            }

            startCampaign() {
                this.createEnvironment('village');
                this.showDialog(
                    'Quest Master',
                    "Welcome to Barovia, brave adventurer! Dark forces stir in the ruins to the north. The villagers live in fear...",
                    [
                        { text: "I will help! What must I do?", action: () => this.acceptQuest() },
                        { text: "Tell me more about these dark forces", action: () => this.learnMore() },
                        { text: "I need to prepare first", action: () => this.hideDialog() }
                    ]
                );
            }

            acceptQuest() {
                this.showDialog(
                    'Quest Master',
                    "Brave soul! Venture to the old ruins and discover what evil dwells there. But beware - goblins guard the entrance!",
                    [
                        { text: "I'm ready. Let's go!", action: () => this.goToRuins() }
                    ]
                );
            }

            learnMore() {
                this.showDialog(
                    'Quest Master',
                    "Ancient evil sleeps beneath the ruins. The vampire lord Strahd once ruled these lands. His curse still lingers...",
                    [
                        { text: "I'll stop this evil!", action: () => this.acceptQuest() }
                    ]
                );
            }

            goToRuins() {
                this.createEnvironment('ruins');
                this.showDialog(
                    'Narrator',
                    "As you approach the crumbling ruins, three goblins emerge from the shadows, weapons drawn!",
                    [
                        { text: "‚öîÔ∏è Draw weapon and attack!", action: () => this.startCombat('goblin', 3) },
                        { text: "ü•∑ Attempt to sneak past (DEX Check)", skill: 'Stealth', action: () => this.sneakPast() }
                    ]
                );
            }

            sneakPast() {
                const roll = this.rollDice(20);
                this.showDiceRoll(roll);
                setTimeout(() => {
                    if (roll >= 14) {
                        this.showDialog('Narrator', `You slip past unnoticed! (Rolled ${roll})`,
                            [{ text: "Continue", action: () => this.exploreRuins() }]);
                    } else {
                        this.showDialog('Narrator', `They spot you! (Rolled ${roll})`,
                            [{ text: "Fight!", action: () => this.startCombat('goblin', 3) }]);
                    }
                }, 1500);
            }

            exploreRuins() {
                this.character.xp += 100;
                this.updateHUD();
                this.showDialog('Narrator',
                    "üéâ Quest Complete! You've explored the ruins and gained valuable experience.",
                    [{ text: "Victory!", action: () => this.hideDialog() }]
                );
            }

            startCombat(enemyType, count = 1) {
                this.combat = {
                    enemies: [],
                    round: 1,
                    currentTurn: 'player',
                    playerDefending: false
                };

                for (let i = 0; i < count; i++) {
                    this.createEnemy(enemyType, {x: -3 + i * 2.5, y: 0, z: -4});
                }

                document.getElementById('combatUI').classList.add('active');
                this.updateCombatUI();
                this.updateInitiativeTimeline();
                this.hideDialog();
            }

            createEnemy(type, pos) {
                const geom = new THREE.CapsuleGeometry(0.4, 1.2, 4, 8);
                const mat = new THREE.MeshPhongMaterial({
                    color: type === 'goblin' ? 0x44ff44 : 0xff4444,
                    emissive: 0x114411
                });
                const mesh = new THREE.Mesh(geom, mat);
                mesh.position.set(pos.x, pos.y + 0.8, pos.z);
                mesh.castShadow = true;
                this.scene.add(mesh);

                const enemy = {
                    type, mesh, hp: 12, maxHp: 12, ac: 13,
                    alive: true, statusEffects: []
                };
                this.combat.enemies.push(enemy);
                this.enemies.push(enemy);
            }

            updateInitiativeTimeline() {
                const timeline = document.getElementById('initiativeTimeline');
                timeline.innerHTML = '';

                // Player
                const playerPortrait = document.createElement('div');
                playerPortrait.className = 'initiative-portrait ally active';
                playerPortrait.textContent = 'üßô';
                timeline.appendChild(playerPortrait);

                // Enemies
                this.combat.enemies.forEach((enemy, i) => {
                    if (enemy.alive) {
                        const portrait = document.createElement('div');
                        portrait.className = 'initiative-portrait enemy';
                        portrait.textContent = enemy.type === 'goblin' ? 'üëπ' : 'üòà';
                        timeline.appendChild(portrait);
                    }
                });
            }

            combatAction(action) {
                if (!this.combat) return;

                const enemy = this.combat.enemies.find(e => e.alive);
                if (!enemy) return;

                let log = '';

                if (action === 'attack') {
                    const roll = this.rollDice(20);
                    const bonus = Math.floor((this.character.str - 10) / 2) + 2;
                    const total = roll + bonus;

                    log += `üé≤ Attack: ${roll} + ${bonus} = ${total}\\n`;

                    if (roll === 20) {
                        const dmg = (this.rollDice(8) + bonus) * 2;
                        enemy.hp -= dmg;
                        log += `üí• CRITICAL HIT! ${dmg} damage!\\n`;
                        this.showFloatingNumber(enemy.mesh.position, dmg, 'crit');
                        this.createParticleEffect(enemy.mesh.position, 0xffee66, 30);
                    } else if (total >= enemy.ac) {
                        const dmg = this.rollDice(8) + bonus;
                        enemy.hp -= dmg;
                        log += `‚öîÔ∏è HIT! ${dmg} damage\\n`;
                        this.showFloatingNumber(enemy.mesh.position, dmg, 'damage');
                        this.createParticleEffect(enemy.mesh.position, 0xff4444, 20);
                    } else {
                        log += `‚ùå MISS!\\n`;
                    }

                    if (enemy.hp <= 0) {
                        enemy.alive = false;
                        enemy.mesh.material.opacity = 0.3;
                        this.character.xp += 50;
                        log += `üíÄ Enemy defeated! +50 XP\\n`;
                    }
                }

                this.addCombatLog(log);

                if (!this.combat.enemies.some(e => e.alive)) {
                    this.endCombat(true);
                    return;
                }

                // Enemy turn
                setTimeout(() => this.enemyTurn(), 800);
                this.updateCombatUI();
                this.updateHUD();
            }

            enemyTurn() {
                const enemy = this.combat.enemies.find(e => e.alive);
                if (!enemy) return;

                const roll = this.rollDice(20);
                let log = `\\nüëπ ${enemy.type} attacks!\\n`;
                log += `üé≤ ${roll} + 3 = ${roll + 3}\\n`;

                if (roll + 3 >= this.character.ac) {
                    const dmg = this.rollDice(6) + 2;
                    this.character.hp -= dmg;
                    log += `üí• HIT! You take ${dmg} damage!\\n`;

                    if (this.character.hp <= 0) {
                        this.endCombat(false);
                        return;
                    }
                } else {
                    log += `üõ°Ô∏è MISS!\\n`;
                }

                this.addCombatLog(log);
                this.updateCombatUI();
                this.updateHUD();
            }

            endCombat(victory) {
                document.getElementById('combatUI').classList.remove('active');
                document.getElementById('combatLog').innerHTML = '';

                this.enemies.forEach(e => this.scene.remove(e.mesh));
                this.enemies = [];

                if (victory) {
                    this.gold += 25;
                    this.showDialog('Victory',
                        `üéâ You won! Gained XP and 25 gold!`,
                        [{ text: "Continue", action: () => this.exploreRuins() }]
                    );
                } else {
                    this.showDialog('Defeat',
                        `üíÄ You have fallen...`,
                        [{ text: "Restart", action: () => location.reload() }]
                    );
                }

                this.combat = null;
            }

            addCombatLog(text) {
                const entry = document.createElement('div');
                entry.className = 'combat-log-entry';
                entry.textContent = text;
                document.getElementById('combatLog').appendChild(entry);
                document.getElementById('combatLog').scrollTop = 999999;
            }

            updateCombatUI() {
                const enemy = this.combat?.enemies.find(e => e.alive);
                if (!enemy) return;

                document.getElementById('playerCombatName').textContent = this.character.name;
                document.getElementById('playerCombatHP').textContent = `${this.character.hp}/${this.character.maxHp}`;
                document.getElementById('enemyCombatName').textContent = enemy.type.toUpperCase();
                document.getElementById('enemyCombatHP').textContent = `${enemy.hp}/${enemy.maxHp}`;
            }

            showDialog(speaker, text, choices) {
                document.getElementById('speakerName').textContent = speaker;
                document.getElementById('dialogText').textContent = text;

                const choicesDiv = document.getElementById('dialogChoices');
                choicesDiv.innerHTML = '';

                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.innerHTML = `${choice.text}${choice.skill ? `<div class="choice-skill">[${choice.skill}]</div>` : ''}`;
                    btn.onclick = choice.action;
                    choicesDiv.appendChild(btn);
                });

                document.getElementById('dialogBox').classList.add('active');
            }

            hideDialog() {
                document.getElementById('dialogBox').classList.remove('active');
            }

            showDiceRoll(result) {
                const dice = document.getElementById('diceRoll');
                dice.textContent = `üé≤ ${result}`;
                dice.style.display = 'block';
                setTimeout(() => dice.style.display = 'none', 1500);
            }

            showFloatingNumber(position, value, type) {
                const div = document.createElement('div');
                div.className = `floating-number ${type}`;
                div.textContent = type === 'crit' ? `${value}!!!` : value;
                div.style.left = (window.innerWidth / 2) + 'px';
                div.style.top = (window.innerHeight / 2) + 'px';
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 1500);
            }

            createParticleEffect(position, color, count) {
                for (let i = 0; i < count; i++) {
                    const geom = new THREE.SphereGeometry(0.1, 8, 8);
                    const mat = new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 1 });
                    const particle = new THREE.Mesh(geom, mat);
                    particle.position.copy(position);
                    particle.velocity = {
                        x: (Math.random() - 0.5) * 0.3,
                        y: Math.random() * 0.4,
                        z: (Math.random() - 0.5) * 0.3
                    };
                    this.scene.add(particle);
                    this.particles.push(particle);
                }
            }

            returnToParticlePool(particle) {
                if (this.particlePool.length < 100) {
                    this.particlePool.push(particle);
                }
            }

            rollDice(sides) {
                return Math.floor(Math.random() * sides) + 1;
            }

            updateHUD() {
                document.getElementById('charNameDisplay').textContent = this.character.name;
                document.getElementById('charClassDisplay').textContent =
                    `Level ${this.character.level} ${this.character.race} ${this.character.class}`;

                const hpPct = (this.character.hp / this.character.maxHp) * 100;
                document.getElementById('hpDisplay').textContent = `${this.character.hp}/${this.character.maxHp}`;
                document.getElementById('hpBar').style.width = hpPct + '%';
                document.getElementById('hpBar').className = `bar-fill hp-bar${hpPct < 30 ? ' low' : ''}`;

                const xpNeeded = 300;
                const xpPct = (this.character.xp / xpNeeded) * 100;
                document.getElementById('xpDisplay').textContent = `${this.character.xp}/${xpNeeded}`;
                document.getElementById('xpBar').style.width = xpPct + '%';

                document.getElementById('strDisplay').textContent = this.character.str;
                document.getElementById('dexDisplay').textContent = this.character.dex;
                document.getElementById('conDisplay').textContent = this.character.con;

                document.getElementById('goldDisplay').textContent = this.gold;
            }

            updateCompanionPanel() {
                const list = document.getElementById('companionList');
                list.innerHTML = '';
                this.companions.forEach(comp => {
                    const card = document.createElement('div');
                    card.className = 'companion-card';
                    card.innerHTML = `
                        <div class="companion-name">${comp.icon} ${comp.name}</div>
                        <div class="companion-class">Level ${comp.level} ${comp.class}</div>
                        <div class="companion-relationship">
                            <div class="relationship-hearts">${'‚ù§Ô∏è'.repeat(comp.relationship)}</div>
                            <div style="color: #aaa; font-size: 0.85em;">Relationship: ${comp.relationship}/5</div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }

            openInventory() {
                const grid = document.getElementById('inventoryGrid');
                grid.innerHTML = '';
                this.inventory.forEach(item => {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot filled';
                    slot.textContent = item.split(' ')[0];
                    slot.title = item;
                    grid.appendChild(slot);
                });
                for (let i = this.inventory.length; i < 20; i++) {
                    grid.appendChild(document.createElement('div')).className = 'inventory-slot';
                }
                document.getElementById('inventoryPanel').classList.add('active');
            }

            closeInventory() {
                document.getElementById('inventoryPanel').classList.remove('active');
            }

            toggleCompanions() {
                document.getElementById('companionPanel').classList.toggle('active');
            }

            interact() {
                this.showDialog('Villager',
                    "Thank you for helping us, hero! The darkness grows stronger each day...",
                    [{ text: "Stay safe", action: () => this.hideDialog() }]
                );
            }

            search() {
                const roll = this.rollDice(20);
                this.showDiceRoll(roll);
                setTimeout(() => {
                    if (roll >= 14) {
                        this.gold += 15;
                        this.updateHUD();
                        this.showDialog('Success', `Found 15 gold! (Rolled ${roll})`,
                            [{ text: "Nice!", action: () => this.hideDialog() }]);
                    } else {
                        this.showDialog('Failure', `Found nothing (Rolled ${roll})`,
                            [{ text: "Darn", action: () => this.hideDialog() }]);
                    }
                }, 1500);
            }

            rest() {
                this.character.hp = this.character.maxHp;
                this.updateHUD();
                this.createParticleEffect(this.player.position, 0x44ff44, 30);
                this.showDialog('Rested',
                    "You rest and recover. HP fully restored!",
                    [{ text: "Refreshed!", action: () => this.hideDialog() }]
                );
            }

            togglePerformanceMonitor() {
                document.getElementById('performanceMonitor').classList.toggle('active');
            }
        }

        let game;
        window.addEventListener('load', () => {
            game = new DnDGameEnhanced();
        });
    </script>
</body>
</html>
