{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "subscriptionId": {
      "type": "String",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "functionAppName": {
      "type": "string",
      "defaultValue": "[concat('copilot365-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of the Function App (must be globally unique)"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[concat('st', uniqueString(resourceGroup().id))]",
      "maxLength": 24,
      "metadata": {
        "description": "Storage Account Name (3-24 characters, lowercase and numbers only)"
      }
    },
    "storageBlobContainerName": {
      "type": "String",
      "defaultValue": "deployments"
    },
    "openAIServiceName": {
      "type": "string",
      "defaultValue": "[concat('openai-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name for the Azure OpenAI Service"
      }
    },
    "openAIModelName": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "allowedValues": [
        "gpt-35-turbo",
        "gpt-4",
        "gpt-4o"
      ],
      "metadata": {
        "description": "Azure OpenAI Model to deploy"
      }
    },
    "openAIDeploymentName": {
      "type": "string",
      "defaultValue": "gpt-deployment",
      "metadata": {
        "description": "Name for the model deployment"
      }
    },
    "openAIDeploymentCapacity": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 300,
      "metadata": {
        "description": "Deployment capacity in thousands of tokens per minute (TPM). Start with 10 and increase if needed based on your quota."
      }
    },
    "assistantName": {
      "type": "string",
      "defaultValue": "Copilot Agent 365",
      "metadata": {
        "description": "Name for the AI Assistant"
      }
    },
    "characteristicDescription": {
      "type": "string",
      "defaultValue": "Enterprise AI assistant integrated with Microsoft 365",
      "metadata": {
        "description": "Description of the assistant's characteristics"
      }
    },
    "openAILocation": {
      "type": "string",
      "allowedValues": [
        "australiaeast",
        "canadaeast",
        "eastus",
        "eastus2",
        "francecentral",
        "japaneast",
        "northcentralus",
        "norwayeast",
        "southcentralus",
        "swedencentral",
        "switzerlandnorth",
        "uksouth",
        "westeurope",
        "westus",
        "westus3"
      ],
      "metadata": {
        "description": "REQUIRED: Select region for Azure OpenAI Service. Choose a region with available quota (different from your resource group region if needed)."
      }
    },
    "pythonVersion": {
      "type": "string",
      "defaultValue": "3.11",
      "allowedValues": [
        "3.9",
        "3.10",
        "3.11"
      ],
      "metadata": {
        "description": "Python version to use"
      }
    },
    "functionAppRuntime": {
      "type": "string",
      "defaultValue": "python",
      "metadata": {
        "description": "Runtime for Function App"
      }
    }
  },
  "variables": {
    "fileShareName": "[concat('azf', parameters('functionAppName'), uniqueString(resourceGroup().id))]",
    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
    "openAIResourceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIServiceName'))]",
    "functionAppId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
    "appServicePlanName": "[concat('asp-', parameters('functionAppName'))]",
    "appInsightsName": "[concat('ai-', parameters('functionAppName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-05-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2",
        "defaultToOAuthAuthentication": true,
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": true,
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2022-05-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', variables('fileShareName'))]",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-05-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('storageBlobContainerName'))]",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "name": "[parameters('openAIServiceName')]",
      "location": "[parameters('openAILocation')]",
      "sku": {
        "name": "S0"
      },
      "kind": "OpenAI",
      "properties": {
        "customSubDomainName": "[parameters('openAIServiceName')]",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[concat(parameters('openAIServiceName'), '/', parameters('openAIDeploymentName'))]",
      "dependsOn": [
        "[variables('openAIResourceId')]"
      ],
      "sku": {
        "name": "Standard",
        "capacity": "[parameters('openAIDeploymentCapacity')]"
      },
      "properties": {
        "model": {
          "format": "OpenAI",
          "name": "[parameters('openAIModelName')]",
          "version": "2024-08-06"
        },
        "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
        "raiPolicyName": "Microsoft.Default"
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('appInsightsName')]",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2024-11-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "Tier": "FlexConsumption",
        "Name": "FC1"
      },
      "kind": "linux",
      "properties": {
        "reserved": true,
        "zoneRedundant": false
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2022-03-01",
      "name": "[parameters('functionAppName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp,linux",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "[variables('storageAccountId')]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), 'default', parameters('storageBlobContainerName'))]",
        "[variables('openAIResourceId')]",
        "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
      ],
      "tags": {
        "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
      },
      "properties": {
        "name": "[parameters('functionAppName')]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "clientAffinityEnabled": false,
        "publicNetworkAccess": "Enabled",
        "httpsOnly": true,
        "functionAppConfig": {
          "deployment": {
            "storage": {
              "type": "blobContainer",
              "value": "[concat('https://', parameters('storageAccountName'), '.blob.core.windows.net/', parameters('storageBlobContainerName'))]",
              "authentication": {
                "type": "StorageAccountConnectionString",
                "storageAccountConnectionStringName": "DEPLOYMENT_STORAGE_CONNECTION_STRING"
              }
            }
          },
          "scaleAndConcurrency": {
            "maximumInstanceCount": 100,
            "instanceMemoryMB": 2048
          },
          "runtime": {
            "name": "python",
            "version": "[parameters('pythonVersion')]"
          }
        },
        "siteConfig": {
          "appSettings": [
            {
              "name": "DEPLOYMENT_STORAGE_CONNECTION_STRING",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountId'), '2022-05-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountId'), '2022-05-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "AZURE_OPENAI_API_KEY",
              "value": "[listKeys(variables('openAIResourceId'), '2023-05-01').key1]"
            },
            {
              "name": "AZURE_OPENAI_ENDPOINT",
              "value": "[reference(variables('openAIResourceId')).endpoint]"
            },
            {
              "name": "AZURE_OPENAI_API_VERSION",
              "value": "2024-02-01"
            },
            {
              "name": "AZURE_OPENAI_DEPLOYMENT_NAME",
              "value": "[parameters('openAIDeploymentName')]"
            },
            {
              "name": "AZURE_FILES_SHARE_NAME",
              "value": "[variables('fileShareName')]"
            },
            {
              "name": "ASSISTANT_NAME",
              "value": "[parameters('assistantName')]"
            },
            {
              "name": "CHARACTERISTIC_DESCRIPTION",
              "value": "[parameters('characteristicDescription')]"
            }
          ],
          "cors": {
            "allowedOrigins": [
              "https://ms.portal.azure.com"
            ]
          }
        }
      }
    }
  ],
  "outputs": {
    "windowsSetupScript": {
      "type": "string",
      "value": "[concat('# Copilot Agent 365 - Windows Setup Script\n# Save as setup.ps1 and run: .\\setup.ps1\n\n$ErrorActionPreference = \"Stop\"\n\nWrite-Host \"\\n\" -NoNewline\nWrite-Host \"\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\" -ForegroundColor Cyan\nWrite-Host \"\u2551   Copilot Agent 365 - Setup (3.11)   \u2551\" -ForegroundColor Cyan\nWrite-Host \"\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\\n\" -ForegroundColor Cyan\n\nWrite-Host \"\u25b6 Checking prerequisites...\" -ForegroundColor Yellow\n\n$pythonCmd = $null\nforeach ($cmd in @(\"python3.11\", \"python3.10\", \"python3.9\", \"python3\", \"python\")) {\n    try {\n        $version = & $cmd --version 2>&1\n        if ($version -match \"Python (3\\.(9|10|11)\\.[0-9]+)\") {\n            $pythonCmd = $cmd\n            Write-Host \"\u2713 Found $version\" -ForegroundColor Green\n            break\n        }\n    } catch {}\n}\n\nif (-not $pythonCmd) {\n    Write-Host \"Python 3.9-3.11 required\" -ForegroundColor Red\n    Write-Host \"Download from: https://www.python.org/downloads/\" -ForegroundColor Yellow\n    exit 1\n}\n\nif (-not (Get-Command git -ErrorAction SilentlyContinue)) {\n    Write-Host \"Git required\" -ForegroundColor Red\n    Write-Host \"Download from: https://git-scm.com/download/win\" -ForegroundColor Yellow\n    exit 1\n}\nWrite-Host \"\u2713 Found Git\" -ForegroundColor Green\n\nif (-not (Get-Command node -ErrorAction SilentlyContinue)) {\n    Write-Host \"\u26a0 Node.js not found\" -ForegroundColor Yellow\n    Write-Host \"Install from: https://nodejs.org/\" -ForegroundColor Cyan\n    Write-Host \"Note: Azure Functions Core Tools requires Node.js\" -ForegroundColor Cyan\n} else {\n    Write-Host \"\u2713 Found Node.js\" -ForegroundColor Green\n    \n    if (-not (Get-Command func -ErrorAction SilentlyContinue)) {\n        Write-Host \"Installing Azure Functions Core Tools...\" -ForegroundColor Yellow\n        npm install -g azure-functions-core-tools@4 --unsafe-perm true\n    } else {\n        Write-Host \"\u2713 Found Azure Functions Core Tools\" -ForegroundColor Green\n    }\n}\n\nWrite-Host \"\u25b6 Setting up project...\" -ForegroundColor Yellow\nif (Test-Path \".git\") {\n    Write-Host \"Repository already exists, pulling updates...\" -ForegroundColor Yellow\n    git pull\n} else {\n    Write-Host \"Cloning repository to current directory...\" -ForegroundColor Yellow\n    git clone https://github.com/kody-w/Copilot-Agent-365.git .\n}\n\nWrite-Host \"\u25b6 Creating configuration...\" -ForegroundColor Yellow\n@\"\n{\n  \"IsEncrypted\": false,\n  \"Values\": {\n    \"AzureWebJobsStorage\": \"', concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccountName'), ';AccountKey=',listKeys(variables('storageAccountId'), '2022-05-01').keys[0].value,';EndpointSuffix=core.windows.net'), '\",\n    \"FUNCTIONS_WORKER_RUNTIME\": \"python\",\n    \"AZURE_OPENAI_API_KEY\": \"', listKeys(variables('openAIResourceId'), '2023-05-01').key1, '\",\n    \"AZURE_OPENAI_ENDPOINT\": \"', reference(variables('openAIResourceId')).endpoint, '\",\n    \"AZURE_OPENAI_API_VERSION\": \"2024-02-01\",\n    \"AZURE_OPENAI_DEPLOYMENT_NAME\": \"gpt-deployment\",\n    \"AZURE_FILES_SHARE_NAME\": \"', variables('fileShareName'), '\",\n    \"ASSISTANT_NAME\": \"Copilot Agent 365\",\n    \"CHARACTERISTIC_DESCRIPTION\": \"Enterprise AI assistant integrated with Microsoft 365\"\n  }\n}\n\"@ | Out-File -FilePath \"local.settings.json\" -Encoding UTF8\nWrite-Host \"\u2713 Configuration created\" -ForegroundColor Green\n\nWrite-Host \"\u25b6 Setting up Python environment...\" -ForegroundColor Yellow\nif (Test-Path \".venv\") { Remove-Item -Recurse -Force .venv }\n& $pythonCmd -m venv .venv\n.venv\\Scripts\\Activate.ps1\npip install --upgrade pip --quiet\n\nif (Test-Path \"requirements.txt\") {\n    pip install -r requirements.txt\n} else {\n    pip install openai==1.55.3 httpx==0.27.2 azure-functions==1.18.0 azure-storage-file==2.1.0 pydantic==1.10.13\n}\nWrite-Host \"\u2713 Python environment ready\" -ForegroundColor Green\n\n@\"\n.venv\\Scripts\\Activate.ps1\nWrite-Host \"Starting Copilot Agent 365...\"\nWrite-Host \"Local URL: http://localhost:7071/api/businessinsightbot_function\"\nfunc start\n\"@ | Out-File -FilePath \"run.ps1\" -Encoding UTF8\n\nWrite-Host \"\\n\" -NoNewline\nWrite-Host \"\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\" -ForegroundColor Green\nWrite-Host \"\u2728 Setup Complete! \u2728\" -ForegroundColor Green\nWrite-Host \"\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\" -ForegroundColor Green\nWrite-Host \"\\nAzure Function URL:\" -ForegroundColor Cyan\nWrite-Host \"  https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function\"\nWrite-Host \"\\nTo run locally: .\\run.ps1\" -ForegroundColor Cyan\nWrite-Host \"\\n\" -NoNewline\n')]"
    },
    "macLinuxSetupScript": {
      "type": "string",
      "value": "[concat('#!/bin/bash\n# Copilot Agent 365 - Mac/Linux Auto-Install Setup Script\n# Save as setup.sh and run: bash setup.sh\n# This script will automatically install missing dependencies\n\nset -e\n\nRED=\"\\033[0;31m\"\nGREEN=\"\\033[0;32m\"\nYELLOW=\"\\033[1;33m\"\nCYAN=\"\\033[0;36m\"\nNC=\"\\033[0m\"\n\necho -e \"${CYAN}\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557${NC}\"\necho -e \"${CYAN}\u2551   Copilot Agent 365 - Setup (3.11)   \u2551${NC}\"\necho -e \"${CYAN}\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d${NC}\"\necho\n\ncommand_exists() {\n    command -v \"$1\" >/dev/null 2>&1\n}\n\ndetect_os() {\n    if [[ \"$OSTYPE\" == \"darwin\"* ]]; then\n        echo \"macos\"\n    elif [[ \"$OSTYPE\" == \"linux-gnu\"* ]]; then\n        echo \"linux\"\n    else\n        echo \"unknown\"\n    fi\n}\n\nOS_TYPE=$(detect_os)\necho -e \"${CYAN}Detected OS: $OS_TYPE${NC}\"\necho\n\ncheck_python_version() {\n    local cmd=$1\n    if command_exists $cmd; then\n        local version=$($cmd --version 2>&1 | grep -oE \"[0-9]+\\.[0-9]+\" | head -1)\n        local major=$(echo $version | cut -d. -f1)\n        local minor=$(echo $version | cut -d. -f2)\n        if [ \"$major\" -eq 3 ] && [ \"$minor\" -ge 9 ] && [ \"$minor\" -le 11 ]; then\n            echo $cmd\n            return 0\n        fi\n    fi\n    return 1\n}\n\ninstall_homebrew() {\n    if [[ \"$OS_TYPE\" == \"macos\" ]]; then\n        if ! command_exists brew; then\n            echo -e \"${YELLOW}Installing Homebrew...${NC}\"\n            /bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n            if [[ -f \"/opt/homebrew/bin/brew\" ]]; then\n                eval \"$(/opt/homebrew/bin/brew shellenv)\"\n            fi\n            echo -e \"${GREEN}\u2713 Homebrew installed${NC}\"\n        else\n            echo -e \"${GREEN}\u2713 Found Homebrew${NC}\"\n        fi\n    fi\n}\n\ninstall_python() {\n    echo -e \"${YELLOW}Installing Python 3.11...${NC}\"\n    if [[ \"$OS_TYPE\" == \"macos\" ]]; then\n        brew install python@3.11\n        echo -e \"${GREEN}\u2713 Python 3.11 installed${NC}\"\n    elif [[ \"$OS_TYPE\" == \"linux\" ]]; then\n        if command_exists apt-get; then\n            sudo apt-get update\n            sudo apt-get install -y python3.11 python3.11-venv python3-pip\n            echo -e \"${GREEN}\u2713 Python 3.11 installed${NC}\"\n        elif command_exists yum; then\n            sudo yum install -y python311 python311-pip\n            echo -e \"${GREEN}\u2713 Python 3.11 installed${NC}\"\n        else\n            echo -e \"${RED}Unable to install Python automatically${NC}\"\n            exit 1\n        fi\n    fi\n}\n\ninstall_git() {\n    echo -e \"${YELLOW}Installing Git...${NC}\"\n    if [[ \"$OS_TYPE\" == \"macos\" ]]; then\n        brew install git\n        echo -e \"${GREEN}\u2713 Git installed${NC}\"\n    elif [[ \"$OS_TYPE\" == \"linux\" ]]; then\n        if command_exists apt-get; then\n            sudo apt-get update\n            sudo apt-get install -y git\n            echo -e \"${GREEN}\u2713 Git installed${NC}\"\n        elif command_exists yum; then\n            sudo yum install -y git\n            echo -e \"${GREEN}\u2713 Git installed${NC}\"\n        else\n            echo -e \"${RED}Unable to install Git automatically${NC}\"\n            exit 1\n        fi\n    fi\n}\n\ninstall_nodejs() {\n    echo -e \"${YELLOW}Installing Node.js and npm...${NC}\"\n    if [[ \"$OS_TYPE\" == \"macos\" ]]; then\n        brew install node\n        echo -e \"${GREEN}\u2713 Node.js and npm installed${NC}\"\n    elif [[ \"$OS_TYPE\" == \"linux\" ]]; then\n        if command_exists apt-get; then\n            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -\n            sudo apt-get install -y nodejs\n            echo -e \"${GREEN}\u2713 Node.js and npm installed${NC}\"\n        elif command_exists yum; then\n            curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -\n            sudo yum install -y nodejs\n            echo -e \"${GREEN}\u2713 Node.js and npm installed${NC}\"\n        else\n            echo -e \"${RED}Unable to install Node.js automatically${NC}\"\n            exit 1\n        fi\n    fi\n}\n\ninstall_func_tools() {\n    echo -e \"${YELLOW}Installing Azure Functions Core Tools...${NC}\"\n    if [[ \"$OS_TYPE\" == \"macos\" ]]; then\n        brew tap azure/functions\n        brew install azure-functions-core-tools@4\n        echo -e \"${GREEN}\u2713 Azure Functions Core Tools installed${NC}\"\n    else\n        if sudo npm install -g azure-functions-core-tools@4 --unsafe-perm true; then\n            echo -e \"${GREEN}\u2713 Azure Functions Core Tools installed${NC}\"\n        else\n            npm install -g azure-functions-core-tools@4\n            echo -e \"${GREEN}\u2713 Azure Functions Core Tools installed${NC}\"\n        fi\n    fi\n}\n\necho -e \"${YELLOW}\u25b6 Checking and installing prerequisites...${NC}\"\n\nif [[ \"$OS_TYPE\" == \"macos\" ]]; then\n    install_homebrew\nfi\n\nPYTHON_CMD=\"\"\nfor cmd in python3.11 python3.10 python3.9 python3 python; do\n    if result=$(check_python_version $cmd); then\n        PYTHON_CMD=$result\n        PYTHON_VERSION=$($cmd --version 2>&1)\n        echo -e \"${GREEN}\u2713 Found $PYTHON_VERSION${NC}\"\n        break\n    fi\ndone\n\nif [ -z \"$PYTHON_CMD\" ]; then\n    echo -e \"${YELLOW}Python 3.9-3.11 not found, installing...${NC}\"\n    install_python\n    for cmd in python3.11 python3.10 python3.9 python3 python; do\n        if result=$(check_python_version $cmd); then\n            PYTHON_CMD=$result\n            PYTHON_VERSION=$($cmd --version 2>&1)\n            echo -e \"${GREEN}\u2713 Found $PYTHON_VERSION${NC}\"\n            break\n        fi\n    done\n    if [ -z \"$PYTHON_CMD\" ]; then\n        echo -e \"${RED}Failed to install Python${NC}\"\n        exit 1\n    fi\nfi\n\nif ! command_exists git; then\n    echo -e \"${YELLOW}Git not found, installing...${NC}\"\n    install_git\nfi\nif ! command_exists git; then\n    echo -e \"${RED}Failed to install Git${NC}\"\n    exit 1\nfi\necho -e \"${GREEN}\u2713 Found Git${NC}\"\n\nif ! command_exists node || ! command_exists npm; then\n    echo -e \"${YELLOW}Node.js/npm not found, installing...${NC}\"\n    install_nodejs\nfi\nif ! command_exists node || ! command_exists npm; then\n    echo -e \"${RED}Failed to install Node.js/npm${NC}\"\n    exit 1\nfi\necho -e \"${GREEN}\u2713 Found Node.js $(node --version)${NC}\"\necho -e \"${GREEN}\u2713 Found npm $(npm --version)${NC}\"\n\nif ! command_exists func; then\n    install_func_tools\nfi\nif command_exists func; then\n    echo -e \"${GREEN}\u2713 Found Azure Functions Core Tools${NC}\"\nelse\n    echo -e \"${YELLOW}\u26a0 Azure Functions Core Tools not available${NC}\"\nfi\n\necho\necho -e \"${YELLOW}\u25b6 Setting up project...${NC}\"\nif [ -d \".git\" ]; then\n    echo -e \"${YELLOW}Repository already exists, pulling updates...${NC}\"\n    git pull\nelse\n    echo -e \"${YELLOW}Cloning repository to current directory...${NC}\"\n    git clone https://github.com/kody-w/Copilot-Agent-365.git .\nfi\n\necho -e \"${YELLOW}\u25b6 Creating configuration...${NC}\"\ncat > local.settings.json << EOF\n{\n  \"IsEncrypted\": false,\n  \"Values\": {\n    \"AzureWebJobsStorage\": \"', concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccountName'), ';AccountKey=',listKeys(variables('storageAccountId'), '2022-05-01').keys[0].value,';EndpointSuffix=core.windows.net'), '\",\n    \"FUNCTIONS_WORKER_RUNTIME\": \"python\",\n    \"AZURE_OPENAI_API_KEY\": \"', listKeys(variables('openAIResourceId'), '2023-05-01').key1, '\",\n    \"AZURE_OPENAI_ENDPOINT\": \"', reference(variables('openAIResourceId')).endpoint, '\",\n    \"AZURE_OPENAI_API_VERSION\": \"2024-02-01\",\n    \"AZURE_OPENAI_DEPLOYMENT_NAME\": \"gpt-deployment\",\n    \"AZURE_FILES_SHARE_NAME\": \"', variables('fileShareName'), '\",\n    \"ASSISTANT_NAME\": \"Copilot Agent 365\",\n    \"CHARACTERISTIC_DESCRIPTION\": \"Enterprise AI assistant integrated with Microsoft 365\"\n  }\n}\nEOF\necho -e \"${GREEN}\u2713 Configuration created${NC}\"\n\necho -e \"${YELLOW}\u25b6 Setting up Python environment...${NC}\"\nrm -rf .venv 2>/dev/null || true\n$PYTHON_CMD -m venv .venv\nsource .venv/bin/activate\npip install --upgrade pip > /dev/null 2>&1\n\nif [ -f \"requirements.txt\" ]; then\n    pip install -r requirements.txt\nelse\n    pip install openai==1.55.3 httpx==0.27.2 azure-functions==1.18.0 azure-storage-file==2.1.0 pydantic==1.10.13\nfi\necho -e \"${GREEN}\u2713 Python environment ready${NC}\"\n\ncat > run.sh << RUNSCRIPT\n#!/bin/bash\nsource .venv/bin/activate\necho \"Starting Copilot Agent 365...\"\necho \"Local URL: http://localhost:7071/api/businessinsightbot_function\"\nfunc start\nRUNSCRIPT\nchmod +x run.sh\n\necho\necho -e \"${GREEN}\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501${NC}\"\necho -e \"${GREEN}\u2728 Setup Complete! \u2728${NC}\"\necho -e \"${GREEN}\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501${NC}\"\necho\necho -e \"${CYAN}Azure Function URL:${NC}\"\necho \"  https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function\"\necho\necho -e \"${CYAN}To run locally: ./run.sh${NC}\"\necho\n')]"
    },
    "localSettingsJson": {
      "type": "string",
      "value": "[concat('{\n  \"IsEncrypted\": false,\n  \"Values\": {\n    \"AzureWebJobsStorage\": \"', concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccountName'), ';AccountKey=',listKeys(variables('storageAccountId'), '2022-05-01').keys[0].value,';EndpointSuffix=core.windows.net'), '\",\n    \"FUNCTIONS_WORKER_RUNTIME\": \"python\",\n    \"AZURE_OPENAI_API_KEY\": \"', listKeys(variables('openAIResourceId'), '2023-05-01').key1, '\",\n    \"AZURE_OPENAI_ENDPOINT\": \"', reference(variables('openAIResourceId')).endpoint, '\",\n    \"AZURE_OPENAI_API_VERSION\": \"2024-02-01\",\n    \"AZURE_OPENAI_DEPLOYMENT_NAME\": \"gpt-deployment\",\n    \"AZURE_FILES_SHARE_NAME\": \"', variables('fileShareName'), '\",\n    \"ASSISTANT_NAME\": \"Copilot Agent 365\",\n    \"CHARACTERISTIC_DESCRIPTION\": \"Enterprise AI assistant integrated with Microsoft 365\"\n  }\n}')]"
    },
    "functionAppName": {
      "type": "string",
      "value": "[parameters('functionAppName')]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[concat('https://', reference(variables('functionAppId')).defaultHostName)]"
    },
    "functionEndpoint": {
      "type": "string",
      "value": "[concat('https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function')]"
    },
    "functionUrlWithKey": {
      "type": "string",
      "value": "[concat('https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function')]"
    },
    "openAIEndpoint": {
      "type": "string",
      "value": "[reference(variables('openAIResourceId')).endpoint]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "setupInstructions": {
      "type": "string",
      "value": "\ud83d\ude80 SETUP INSTRUCTIONS:\n\n\ud83d\udcf1 FOR WINDOWS:\n1. Copy the 'windowsSetupScript' output value\n2. Save as 'setup.ps1'\n3. Run: .\\setup.ps1\n\n\ud83c\udf4e FOR MAC/LINUX:\n1. Copy the 'macLinuxSetupScript' output value\n2. Save as 'setup.sh'\n3. Run: bash setup.sh\n\n\u2705 Scripts automatically:\n- Install Python 3.11 (if not found)\n- Install Git (if not found)\n- Install Node.js and npm (if not found)\n- Install Azure Functions Core Tools\n- Clone Copilot-Agent-365 repo\n- Create local.settings.json with YOUR Azure credentials\n- Setup Python environment\n- Create run scripts\n\n\u26a1 FULLY AUTOMATED - No manual installation required!"
    }
  }
}
